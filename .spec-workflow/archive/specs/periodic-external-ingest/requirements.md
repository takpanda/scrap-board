# Spec: periodic-external-ingest

作成日: 2025-09-20

短い概要:
はてなブックマーク、Qiita、及びその他公開フィード（RSS/Atom）を定期的に取得し、Scrap-Board のドキュメントとして保存・索引化する機能。取得したコンテンツは重複排除・メタデータ付与・要約・埋め込み生成を行い、既存ドキュメントと関連づけて「関連ドキュメント」として利用可能にする。

目的:
- 開発者・リサーチャーが最新の技術情報や記事を自動的に取り込み、スクラップや後続の分類・検索・要約処理に利用できるようにする。

スコープ (in-scope):
- はてなブックマークとQiitaの新着API/フィードを定期ポーリングで取得する。
- RSS/Atom フィードの取り込みをサポートする。
- 取得時にHTML抽出（`app/services/extractor.py`）、テキスト正規化、言語検出を実行する。
- 既存DB（`data/scraps.db`）へ保存し、必要なメタ（source, original_url, author, published_at, fetched_at）を記録する。
- 重複判定（URL、ハッシュ、類似度閾値）とマージルールを実装する。
- 取り込み後に要約・埋め込みの生成をワークフローでトリガーする（`app/services/llm_client.py` を利用）。
- 管理用UI（`/admin/sources` 等）でソースの有効/無効、スケジュール設定を行えるようにする（APIエンドポイントの追加）。
- 取得したページの `favicon.ico` を可能な限りサムネイルとして取得・保存し、ドキュメント一覧や詳細で表示できるようにする。`favicon.ico` が無い場合は `og:image` 等のメタ画像を代替として利用する。

スコープ外 (out-of-scope):
- 有料APIや認証が必要なサードパーティサービスの統合（別途検討）。
- 高度な重複解決のための人手インタラクションUI（初期は自動ルールのみ）。

利害関係者:
- プロダクトオーナー
- 開発チーム（バックエンド、フロントエンド）
- 利用者（リサーチャー、開発者）

ユーザーストーリー:
- ユーザーとして、Qiita のタグ「機械学習」の新着記事を自動で取り込み、検索ですぐに見つけられるようにしたい。
- ユーザーとして、はてなブックマークで保存した気になる記事を Scrap-Board に自動で取り込み、後でまとめて読めるようにしたい。
- 管理者として、特定ソース（例: Qiita）の取り込みを一時停止したい。

EARS / 要件の性質:
- Periodic: ポーリングスケジュール（例: 5分、1時間、日次）をサポートし、定期取得で最新コンテンツを取り込む。
- Robust: フェイル時はリトライとバックオフを行い、ログに残す。
- Idempotent: 同一コンテンツは重複保存されないこと。

非機能要件:
- 日本語を含むマルチバイトテキストの正確な抽出・保存。
- LLM 統合はローカルの LM Studio / Ollama に依存し、タイムアウト設定を尊重する（`TIMEOUT_SEC`）。
- 取得ジョブはメモリ4GB程度で動作可能な設計（モデル推論は別プロセス/サービスに委譲）。

受け入れ基準 / Acceptance Tests:
1. Qiita の指定タグ（例: `機械学習`）から記事を取り込み、`documents` テーブルに1件以上保存される。
2. はてなブックマークの新着を定期取得して、少なくとも1件は `documents` に取り込まれる。
3. 同一URLを再取得しても新規ドキュメントは作成されない（重複排除が働く）。
4. 取得されたドキュメントに `source`, `original_url`, `fetched_at`, `published_at`, `author` が正しく保存される。
5. 取り込み後、自動で要約生成ジョブと埋め込み生成ジョブがキックされ、`summaries` と `embeddings` テーブル（または対応するストレージ）に出力が入る。
7. 取得したドキュメントに `thumbnail_url`（もしくは内部ストレージへの参照）が保存され、一覧・詳細で表示される。優先順は `favicon.ico` → `og:image` → 空（未設定）。
6. 管理UIでソースごとの有効/無効切替とスケジュールが操作可能で、設定変更は即時反映される。

実装のヒント / リファレンス:
- 既存の抽出ロジック: `app/services/extractor.py`
- LLM クライアント: `app/services/llm_client.py`
- データベース接続: `app/core/database.py` とマイグレーションフォルダ
- フロントエンドテンプレート: `templates/` フォルダを参照

セキュリティとプライバシー:
- 外部ソースのクロールは `robots.txt` を尊重する。
- 取り込みするデータは指定の LLM エンドポイント以外に送信しない。設定で送信先を制限可能にする。

リスクと軽減策:
- サードパーティAPIのレート制限: バックオフとキューイングで軽減。
- 取得したコンテンツのノイズ（広告やHTMLの断片）: `extractor` での正規化・フィルタリングルールを強化。

次のアクション:
1. この `requirements.md` をレビューしてください。
2. 承認をリクエストする準備ができたら言ってください（承認リクエストはファイルパスのみ送信します）。
