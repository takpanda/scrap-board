# 要件: AI要約をURL追加時に事前生成してDB保存する

## 概要
ウェブからURLを取り込む際に、取得した記事の本文に対してAI要約を即時に生成し、その要約をデータベースに保存することで、記事詳細表示時のレスポンス性能を改善する。

この仕様は、取り込み（ingest）フローに要約生成を組み込み、閲覧時にLLM呼び出しを行わずに高速に要約を返せるようにすることを目的とする。

## 背景と目的
- 現状: 記事詳細ページで要約を表示する際に、その都度LLMへ問い合わせを行っており、レスポンス遅延や外部サービス依存が発生している。
- 目的: 取り込み時に要約を生成・保存することで、表示時の遅延を削減し、LLMサービスの呼び出し回数を抑制する。

## スコープ
- 対象: URL経由で取り込まれるHTML記事（Trafilaturaで抽出可能なコンテンツ）。
- 除外: 画像のみのPDF、または本文が存在しないページ。
- 保存先: 既存の`documents`テーブルへ要約カラムを追加し、短要約（short_summary）と中要約（medium_summary）を格納する。

## ユーザーストーリー
- ユーザーとして、記事一覧や記事詳細を素早く開きたい。取り込み時に要約が生成されていれば、即座に要約が表示される。 
- 管理者として、LLMコストとレスポンス時間を削減したい。取り込み時に要約を作成しておけば、表示時の外部呼び出しを削減できる。

## 受け入れ基準
1. URL取り込みAPI (`POST /ingest/url`) に対して成功時、レスポンスに`document_id`が含まれること（既存動作）。
2. 取り込みが成功した後、対象ドキュメントのDBレコードに`short_summary`と`medium_summary`が保存されていること。
3. 記事詳細表示API/ページは、保存済み`short_summary`を使用して表示できること。表示時にLLM呼び出しが行われないこと。
4. 取り込み中に要約生成が失敗した場合、取り込み自体はロールバックせずに成功させ、代わりに要約カラムには`NULL`あるいは空文字が入ること。失敗はログに記録されること。
5. 要約生成は日本語を優先で出力する（コンテンツが日本語の場合）。英語など他言語のコンテンツは元言語で要約を生成する。

## 非機能要件
- パフォーマンス: 取り込みAPIのP50追加処理時間は、要約生成を含んでも平均で8秒以内（重いモデル使用時は設計でバウンディングを工夫する）。
- 可観測性: 要約生成の成功/失敗、生成時間、使用したモデル名をログに出力すること。
- フォールバック: LLMサービスが利用不可のときは、要約生成をスキップし、取り込みは継続すること。
- ストレージ: 要約はUTF-8で保存し、最大長は短要約: 1024文字、中要約: 4096文字を想定する。

## 制約
- LLMサービスに依存するため、外部サービスの遅延やコストが発生する。
- 既存のDBスキーマ変更を伴うため、マイグレーションが必要。

## 関連ファイル/影響範囲
- API: `api/routes/ingest.py` のURL ingestハンドラ
- サービス: `services/extractor.py`, `services/llm_client.py`
- DB: `core/database.py` と `documents` テーブル定義（マイグレーション）
- UIテンプレート: `templates/document_detail.html` と `templates/documents.html`

## テストケース（受け入れテスト）
1. 正常な日本語記事URLを取り込むと、DBの`short_summary`が非NULLで、記事詳細の要約が表示される。
2. LLM接続を切断した状態でURL取り込みを行うと、取り込みは成功し要約はNULLになる。
3. 大きな記事（例: 5000語）を取り込んだ際に、要約生成のタイムアウトが発生しても取り込みは成功し、ログにタイムアウトが記録される。

## 次のステップ
1. この要件ドキュメントを確認のうえ、承認ワークフローに提出する。
2. 承認後、デザイン（`design.md`）を作成する。
