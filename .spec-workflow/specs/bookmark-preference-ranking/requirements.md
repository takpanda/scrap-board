# 要件定義書

## はじめに

ブックマーク済み記事からユーザーの閲読嗜好を推定し、そのプロファイルを用いて新規取得ドキュメントを関連度順に並び替えるパーソナライズ機能を実装する。これにより、日々大量に取り込まれる記事から興味の高いものを素早く見つけられる体験を提供する。

## プロダクトビジョンとの整合性

本機能は、Scrap-Board が掲げる「日本語コンテンツを効率的に収集し、読む価値のある情報を即座に提示する」という価値提案を強化する。興味度の高い記事を先頭に表示することで、軽量なワークフローとLLM要約の効果を最大化する。

## 機能要件

### 要件1

**ユーザーストーリー:** 頻繁にScrap-Boardを利用する読者として、ブックマークの傾向から自分の興味を推定してもらい、新着記事にその結果が反映されてほしい。

#### 受け入れ条件

1. WHEN ドキュメントがブックマークされたとき THEN システムは5分以内にユーザー嗜好プロファイルを更新しなければならない。
2. IF ユーザーのブックマーク件数が3件未満である場合 THEN システムはプロファイルをコールドスタート扱いとし、ランキングへの影響を無効化しなければならない。
3. WHEN プロファイル更新ジョブが失敗し AND リトライ上限に達したとき THEN システムは警告ログを出力し、対象ドキュメントを手動確認のキューに積まなければならない。

### 要件2

**ユーザーストーリー:** 新しく取り込まれた記事を閲覧するユーザーとして、推定された興味順に一覧が並び替わってほしい。そうすれば最も関連性の高い記事から効率よく読める。

#### 受け入れ条件

1. WHEN ユーザーが推奨ソートを選択した状態でドキュメント一覧ページを開いたとき THEN システムは個別関連度スコアの降順で結果を返さなければならない。
2. IF ドキュメントにパーソナライズ済みスコアが存在しない場合 THEN システムはデフォルトソートへフォールバックし、一覧に欠損を生じさせてはならない。
3. WHEN ユーザーが手動でソート方法を切り替えたとき THEN システムは現在セッションにおいて選択されたソート状態を保持しなければならない。

### 要件3

**ユーザーストーリー:** 上級ユーザーとして、記事が推奨された理由を可視化してほしい。そうすれば結果への信頼が高まり、必要に応じて調整も行える。

#### 受け入れ条件

1. WHEN ユーザーがランキング済みドキュメントを確認したとき THEN システムはカテゴリ一致やドメイン、類似度スコアなど主要な寄与要素を日本語で提示しなければならない。
2. IF 関連度スコアがコールドスタートの初期値に基づいている場合 THEN システムはパーソナライズが未有効である旨のメッセージを表示しなければならない。
3. WHEN ユーザーが「関連性が低い」とフィードバックしたとき THEN システムは将来の嗜好再調整に備えてその記録を保存しなければならない。

## 非機能要件

### コードアーキテクチャとモジュール性
- **単一責務の原則**: プロファイル計算、スコア算出、表示ロジックをそれぞれ独立したモジュールに分離する。
- **モジュラー設計**: 嗜好データはサービスインターフェースを通じてAPIルートとバックグラウンドジョブの両方から再利用できるよう公開する。
- **依存関係の管理**: FastAPIルートから直接DB操作を行わず、サービスまたはリポジトリ層を経由させる。
- **明確なインターフェース**: 嗜好プロファイルとスコア結果を表現するためにPydanticモデルまたはデータクラスを定義する。

### パフォーマンス
- ブックマークイベントから嗜好プロファイル更新までの中央値は5分以内とする。
- `/documents` エンドポイントにおけるランキング処理は、P95で既存レイテンシに150ms以上加算してはならない。

### セキュリティ
- パーソナライズデータはローカル環境内で保持し、外部LLMエンドポイントへ送信してはならない。
- 将来的なマルチユーザー対応を見据え、嗜好データへのアクセスはユーザーID単位でスコープを分離できるようにする。

### 信頼性
- バックグラウンドジョブは指数バックオフ付きで最低3回のリトライを実施する。
- 嗜好プロファイルが利用できない場合はランキングをデフォルト順にフォールバックさせ、機能低下を明示する。

### ユーザビリティ
- 推薦理由を説明するUIテキストは自然な日本語で表記する。
- 推奨ソートの切り替え操作はドキュメント一覧から2クリック以内で到達できるようにする。
