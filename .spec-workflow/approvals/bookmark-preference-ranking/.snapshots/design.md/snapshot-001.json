{
  "id": "snapshot_1759060809222_qfhjgktha",
  "approvalId": "approval_1759060809197_vrlxviszn",
  "approvalTitle": "bookmark-preference-ranking design approval",
  "version": 1,
  "timestamp": "2025-09-28T12:00:09.222Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nブックマーク履歴からユーザー嗜好プロファイルを生成し、新着コンテンツを関連度順に提示するパーソナライズ機能を実装する。バックグラウンドで嗜好プロファイルを更新し、事前計算したスコアを `/documents` 一覧やHTMXパーシャルから取得することで、レスポンス性能と説明可能性の両立を図る。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- 既存のFastAPIモノリス構成とサービス層分離方針を維持し、新規ロジックは `app/services/` 配下に配置する。\n- LLMクライアントは既存の `LLMClient` を再利用し、外部APIへの通信はこれを経由することで抽象レイヤーを統一する。\n- 全処理はローカルDBとローカルLLMで完結し、技術方針で定められた「単一コンテナで完結」を崩さない。\n- バックグラウンドジョブは既存のDBキューワーカー（`postprocess_queue` パターン）を踏襲し、指数バックオフ付きの信頼性要件を満たす。\n\n### Project Structure (structure.md)\n- `app/services/preference_profile.py` を新設し、嗜好プロファイル計算を担当させる。\n- `app/services/personalized_ranking.py` を追加し、スコア計算と説明生成を一元化する。\n- `app/api/routes/documents.py` と `app/templates/documents.html` に最小限の変更でソート切り替えと説明UIを追加する。\n- 新規DBテーブルは `migrations/006_create_preference_tables.sql`（仮）で管理し、既存 `migrations` ディレクトリ構造に従う。\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`Bookmark` モデル / `bookmark_service`**: ブックマーク追加時のイベントフックを再利用し、嗜好更新ジョブを発行する。\n- **`postprocess_queue.enqueue_job_for_document` パターン**: DBキューベースの非同期処理と指数バックオフ実装を流用し、新ジョブキューを実装する。\n- **`similarity.calculate_document_similarity`**: 既存のコサイン類似度ロジックを抽出再利用し、ユーザーベクトルとドキュメント埋め込みの類似度計算に適用する。\n- **`LLMClient.create_embedding`**: ブックマークメモや抽出要約からユーザープロファイルベクトルを生成する際に利用する。\n- **`templates/partials/notification` 等のHTMX UI基盤**: 推薦理由UIやソートトグルの表示でスタイルとJSユーティリティを再利用する。\n\n### Integration Points\n- **`app/api/routes/bookmarks.py`**: ブックマーク作成／削除時に嗜好更新ジョブを発行し、非同期処理開始を保証する。\n- **`app/api/routes/documents.py`**: クエリパラメータ `sort=personalized` により `PersonalizedScoreRepository` を介してランキングを取得する。\n- **`app/services/postprocess.py`**: ドキュメント埋め込み生成完了後にスコア再計算ジョブを発行し、新規ドキュメントをパーソナライズ結果に含める。\n- **`templates/documents.html` & `templates/partials/document_card.html`**: スコア表示と推薦理由のUI拡張。\n\n## Architecture\n\nブックマークイベントと新規ドキュメント取り込みの双方から更新ジョブを発行し、ワーカーが嗜好プロファイルおよびパーソナライズ済みスコアを計算する。計算結果は専用テーブルにキャッシュされ、一覧表示時は軽量クエリで取得する。\n\n### Modular Design Principles\n- **Single File Responsibility**: 嗜好計算、スコア算出、UI整形をそれぞれ専用モジュールに分割する。\n- **Component Isolation**: プロファイル計算とスコア計算はインターフェースを介して連携し、直接DBを共有しない。\n- **Service Layer Separation**: APIルートはサービス層経由でデータ取得し、SQLAlchemyクエリを直接持たない。\n- **Utility Modularity**: 類似度計算や説明生成ロジックはユーティリティ化してテスト可能にする。\n\n```mermaid\ngraph TD\n    BM[ブックマークAPI] -->|enqueue| PJ[(preference_jobs)]\n    INGEST[新規ドキュメント取込] -->|enqueue| PJ\n    PJ -->|poll| Worker[Preference Worker]\n    Worker --> PP[PreferenceProfileService]\n    PP --> PF[(preference_profiles)]\n    Worker --> RS[PersonalizedRankingService]\n    RS --> PS[(personalized_scores)]\n    RS --> EX[(explanations_json)]\n    UI[ドキュメント一覧 API/UI] -->|sort=personalized| Repo[PersonalizedScoreRepository]\n    Repo --> PS\n    UI -->|fallback| DefaultSort[従来ソート]\n```\n\n## Components and Interfaces\n\n### PreferenceProfileService\n- **Purpose:** ブックマーク集合からユーザー嗜好ベクトルとカテゴリ・ドメイン重みを算出する。\n- **Interfaces:** `update_profile(user_id: Optional[str], db: Session) -> PreferenceProfileDTO`\n- **Dependencies:** `LLMClient`, `Bookmark`/`Document` ORM, `numpy`\n- **Reuses:** 既存埋め込み生成（`LLMClient.create_embedding`）、`similarity` のベクトル処理補助\n\n### PersonalizedRankingService\n- **Purpose:** プロファイルと未読ドキュメントを入力にスコアと説明要素を計算する。\n- **Interfaces:** `score_documents(profile: PreferenceProfileDTO, documents: List[Document]) -> List[PersonalizedScoreDTO]`\n- **Dependencies:** `PreferenceProfileService` DTO, `Embeddings`, `Classification`\n- **Reuses:** `calculate_document_similarity` を内部利用し、カテゴリ一致・ドメイン親和性を合成\n- **Scoring Contract:** `score = 0.5 * similarity + 0.25 * category_affinity + 0.15 * domain_affinity + 0.1 * freshness_decay`\n   - `similarity`: ユーザープロファイル埋め込みとドキュメント埋め込み（chunk0）とのコサイン類似度。\n   - `category_affinity`: プロファイルのカテゴリ重みマップから主要カテゴリの重みを参照し、0〜1へ正規化。\n   - `domain_affinity`: 過去ブックマークのドメイン頻度に基づく0〜1スコア。\n   - `freshness_decay`: $\\exp\\left(-\\frac{\\text{hours since created}}{72}\\right)$ により、直近72時間を優遇する。\n   - スコアは0〜1にクリップし、`rank` は高スコア順に1起算で付与する。\n\n### PersonalizationJobDispatcher\n- **Purpose:** ブックマークイベントおよびドキュメント処理完了時にジョブを登録する。\n- **Interfaces:** `enqueue_profile_update(document_id: str, user_id: Optional[str])`, `enqueue_recompute_for_document(document_id: str)`\n- **Dependencies:** 新規 `preference_jobs` テーブル、`SessionLocal`\n- **Reuses:** `postprocess_queue` の `enqueue_job_for_document` 実装パターン\n\n### PreferenceWorker\n- **Purpose:** `preference_jobs` をポーリングし、プロフィール更新とスコア再計算を実施する常駐ワーカー。\n- **Interfaces:** `run_worker(poll_interval: float = 2.0)`\n- **Dependencies:** `PreferenceProfileService`, `PersonalizedRankingService`\n- **Reuses:** 既存ワーカーループのログ／バックオフ実装思想を踏襲\n\n### PersonalizedScoreRepository\n- **Purpose:** `personalized_scores` テーブルから高速に結果を取得し、API/UIへ渡す。\n- **Interfaces:** `get_scores_for_user(user_id: Optional[str], limit: int, offset: int) -> List[PersonalizedScoreDTO]`, `bulk_upsert(scores: List[PersonalizedScoreDTO])`\n- **Dependencies:** SQLAlchemy `Session`, 新規モデル\n- **Reuses:** 既存 `Document` リレーションを活用し、テンプレート向けに `document` を eager load\n\n### ExplanationPresenter\n- **Purpose:** スコア構成要素（カテゴリ一致度、ドメイン頻度、類似度）を日本語テキストに整形する。\n- **Interfaces:** `render(reason: ExplanationBreakdown) -> str`\n- **Dependencies:** `jinja2` テンプレート断片 or プレーンテキスト生成\n- **Reuses:** `templates/partials` の通知スタイル・アイコン\n\n## Data Models\n\n### PreferenceProfile\n```\nPreferenceProfile (新規テーブル: preference_profiles)\n- id: TEXT (UUID)\n- user_id: TEXT, nullable (現状NULL=匿名ユーザー)\n- bookmark_count: INTEGER\n- profile_embedding: TEXT (JSON-encoded List[float])\n- category_weights: TEXT (JSON map: category -> weight)\n- domain_weights: TEXT (JSON map: domain -> weight)\n- last_bookmark_id: TEXT (最新ブックマーク追跡)\n- updated_at: DATETIME\n- created_at: DATETIME\n```\n\n### PersonalizedScore\n```\nPersonalizedScore (新規テーブル: personalized_scores)\n- id: TEXT (UUID)\n- user_id: TEXT, nullable\n- document_id: TEXT (FK -> documents.id)\n- score: FLOAT (0〜1正規化)\n- rank: INTEGER (順位キャッシュ)\n- components: TEXT (JSON {\"similarity\": float, \"category\": float, \"domain\": float, \"freshness\": float})\n- explanation: TEXT (日本語文章)\n- computed_at: DATETIME\n- UNIQUE(user_id, document_id)\n```\n\n### PreferenceFeedback\n```\nPreferenceFeedback (新規テーブル: preference_feedbacks)\n- id: TEXT (UUID)\n- user_id: TEXT, nullable\n- document_id: TEXT\n- feedback_type: TEXT (\"low_relevance\" 等)\n- metadata: TEXT (JSON)\n- created_at: DATETIME\n```\n\n## Error Handling\n\n### Error Scenarios\n1. **埋め込み生成失敗:**\n   - **Handling:** LLMクライアント例外時は1回リトライ、失敗時はプロファイルを `status=cold_start` で保存し、UIへフォールバックを通知。\n   - **User Impact:** 推薦ソート選択時に「パーソナライズが未有効です」メッセージを表示。\n\n2. **ジョブ処理上限到達:**\n   - **Handling:** `preference_jobs` は `max_attempts=3` で指数バックオフ、失敗時は `failed` マークと警告ログを出力し、管理者向けのメトリクスに計上。\n   - **User Impact:** ランキングはデフォルト順で表示、UIトーストで「一時的に標準ソートを利用しています」を表示。\n\n3. **データ不整合（ドキュメント削除済み）:**\n   - **Handling:** スコア再計算時に `document_id` が存在しなければ該当行を削除し、ジョブを成功扱いで終了。\n   - **User Impact:** リストから該当エントリが消えるだけでエラー表示は行わない。\n\n## Testing Strategy\n\n### Unit Testing\n- `PreferenceProfileService` のプロファイル生成ロジック（平均ベクトル・カテゴリ集計）の単体テスト。\n- `PersonalizedRankingService` のスコア合成と正規化、説明テキスト整形のテスト。\n- `PersonalizedScoreRepository.bulk_upsert` の重複排他と更新動作検証。\n\n### Integration Testing\n- `tests/test_documents_personalized.py`（新規）で`sort=personalized` クエリ時のレスポンス順序とフォールバック挙動を検証。\n- ブックマークAPIからジョブ発行→ワーカー処理→スコア反映までを `tmp_test_db` を用いたエンドツーエンドで確認。\n- フィードバック登録 (`feedback_type=low_relevance`) 後にプロファイル再計算キューが積まれることを確認。\n\n### End-to-End Testing\n- Playwrightテストにソートトグル操作と推薦理由表示検証を追加し、日本語テキストの表示をスクリーンショット比較で確認。\n- コールドスタート（ブックマーク2件以下）時に「パーソナライズ無効」表示とデフォルトソートが維持されることをUIテストで確認。\n",
  "fileStats": {
    "size": 11599,
    "lines": 176,
    "lastModified": "2025-09-28T11:59:38.914Z"
  },
  "comments": []
}