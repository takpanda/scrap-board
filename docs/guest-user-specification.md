# Guest User ID仕様

## 概要

ユーザーが特定できない場合（未ログイン・未認証）は、全てのユーザー関連処理で共通の `"guest"` ユーザーIDとして登録・管理します。

**現在の運用前提**: このシステムは1人のユーザー（個人利用）を想定して設計されており、全てのデータは `user_id="guest"` で管理されています。将来的に複数ユーザー対応（認証機能）を実装する際は、この仕様を拡張する予定です。

## 背景

以前は、ユーザー未特定の場合に `user_id=None` (NULL) で処理していましたが、これによりランキング、重複判定、データ集計に不整合が生じていました。全ての未特定ユーザーを統一されたIDで管理することで、これらの問題を解決します。

## 仕様

### 定数

```python
GUEST_USER_ID = "guest"
```

この定数は `app.core.user_utils` で定義されています。

### 正規化関数

```python
def normalize_user_id(user_id: Optional[str]) -> str:
    """
    user_idを正規化し、Noneまたは空文字列の場合は"guest"を返します。
    
    Args:
        user_id: ユーザーID（Noneまたは空文字列の可能性あり）
        
    Returns:
        正規化されたユーザーID - 未特定ユーザーの場合は"guest"、それ以外は元のuser_id
    """
```

### 適用範囲

以下の全ての機能で `"guest"` IDが使用されます：

1. **ブックマーク機能** (`app/api/routes/bookmarks.py`)
   - ブックマークの作成・取得・削除
   - 重複排除（同一ユーザー・同一ドキュメントの組み合わせ）

2. **フィードバック機能** (`app/services/personalized_feedback.py`)
   - パーソナライズフィードバックの登録
   - 重複排除（同一ユーザー・同一ドキュメント・同一フィードバックタイプの組み合わせ）

3. **嗜好プロファイル** (`app/services/preference_analysis.py`)
   - ユーザー嗜好の分析
   - プロファイル情報の取得

4. **パーソナライズスコア** (`app/services/personalized_repository.py`)
   - スコアの登録・取得・削除
   - ランキング計算

5. **ドキュメント取得** (`app/api/routes/documents.py`)
   - パーソナライズされたドキュメントリストの取得
   - 認証済みユーザーはguestスコアをフォールバックとして利用

## データベース変更

### マイグレーション

既存の `user_id=NULL` データを `"guest"` に変換するマイグレーションスクリプトが提供されています：

```bash
# ドライラン（変更内容の確認）
python migrations/migrate_null_to_guest.py --dry-run

# 実際のマイグレーション実行
python migrations/migrate_null_to_guest.py
```

### 影響を受けるテーブル

- `bookmarks`
- `preference_feedbacks`
- `preference_profiles`
- `personalized_scores`

## API動作

### ユーザーID解決

各APIエンドポイントで使用される `_resolve_user_id()` 関数は、以下の順序でユーザーIDを解決します：

1. `request.state.user` からユーザー情報を取得
2. `X-User-Id` ヘッダーから取得
3. 上記いずれも存在しない場合は `"guest"` を返却

### 例

```python
# ヘッダーなしでAPIを呼び出し
POST /api/bookmarks
{
  "document_id": "doc-123"
}

# 内部的には user_id="guest" として処理される
```

## テスト

ゲストユーザー機能のテストは `tests/test_guest_user.py` に含まれています：

- ユーザーID正規化のテスト
- ゲストユーザーのブックマーク作成・取得
- 重複排除の検証
- 認証済みユーザーとゲストユーザーの分離

## 運用上の注意

### スパム対策

ゲストユーザーは全て同一IDで管理されるため、以下の考慮が必要です：

- レート制限: APIレベルでのレート制限実装を推奨
- データ検証: 不正なデータの検出と削除
- セッション管理: 必要に応じてセッショントークンでの細分化

### データ分析

- `user_id="guest"` のデータは全て匿名ユーザーの集約データ
- 個別の匿名ユーザーを追跡する場合は、セッショントークンやブラウザフィンガープリントを別途活用

## パーソナライゼーション機能の暫定設定

### コールドスタート閾値

**現在の設定**: `DEFAULT_COLD_START_THRESHOLD = 1`

1人ユーザー前提のため、1件のブックマークでパーソナライゼーション機能を有効化する設定になっています。

- **メリット**: 少ないブックマークでも即座にパーソナライズされたおすすめが利用可能
- **デメリット**: データが少ない段階での推薦精度は限定的
- **コールドスタート時のメッセージ**: 「ブックマークを追加すると、おすすめ順の精度が向上します。」

### 将来の認証実装時の移行

複数ユーザー環境に移行する際は、以下の調整が推奨されます：

1. **閾値の引き上げ**: `DEFAULT_COLD_START_THRESHOLD` を 3 程度に変更
2. **ユーザー識別の実装**: 
   - クッキーまたはセッションベースの一時的な識別
   - 本格的な認証システム（OAuth、JWT等）の導入
3. **データマイグレーション**: 既存の `"guest"` データの取り扱い方針を決定
   - 保持して全ユーザーの初期データとして利用
   - 削除してクリーンスタート
   - 特定ユーザーに紐付け

## 今後の拡張

- セッショントークンベースの匿名ユーザー識別
- ゲストユーザーの登録への変換フロー
- ゲストデータのクリーンアップポリシー
- マルチユーザー認証機能（OAuth2.0、JWT等）
- ユーザーごとのパーソナライゼーションプロファイル管理
