# Implementation Plan

## 実装タスク

### フェーズ1: 基盤実装

- [ ] 1. モバイル環境判定とスワイプ検出の基盤を構築する
  - ビューポート幅を監視し、モバイル環境（768px未満）かデスクトップ環境（768px以上）かを判定する機能を実装
  - ウィンドウリサイズ時にモバイル/デスクトップ環境を再判定し、スワイプ機能の有効/無効を動的に切り替える
  - タッチイベント（touchstart、touchmove、touchend）を監視し、スワイプジェスチャーを検出する機能を実装
  - 水平方向のスワイプ距離が垂直方向の2倍以上の場合のみスワイプと判定し、縦スクロールと区別する
  - スワイプ距離が最小閾値（50px）を超えた場合のみスワイプ操作として認識する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 1.1 ViewportDetectorを実装する
  - ビューポート幅を取得し、モバイル閾値（768px）と比較する機能を実装
  - ResizeObserverまたはリサイズイベントでウィンドウサイズ変更を監視する機能を実装
  - リサイズイベントにデバウンス処理（200ms）を適用し、連続発火を制御
  - モバイル⇔デスクトップ環境切り替え時のみコールバックを発火し、無駄な処理を削減
  - スワイプ機能の有効化/無効化を通知するコールバック機構を実装
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 1.2 SwipeGestureDetectorを実装する
  - touchstartイベントで初期タッチ位置（startX、startY）とタイムスタンプを記録
  - touchmoveイベントで現在タッチ位置を取得し、スワイプ距離をリアルタイム計算
  - 水平方向の移動距離が垂直方向の移動距離の2倍以上かチェックし、スワイプ方向を判定
  - touchendイベントで最終スワイプ距離を計算し、閾値（50px）を超えた場合のみスワイプイベントを発火
  - スワイプ方向（left/right）、距離、継続時間を含むSwipeEventオブジェクトを生成
  - デバウンス処理（200ms）を適用し、連続スワイプによる重複イベント発火を防止
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 2. 記事リストキャッシュとナビゲーション基盤を構築する
  - ドキュメント一覧ページの記事IDリストをセッションストレージに保存する機能を実装
  - 現在の記事IDから次/前の記事IDを取得する機能を実装
  - リスト端（最初/最後の記事）での隣接記事取得時にnullを返す処理を実装
  - キャッシュの存在確認、クリア、タイムスタンプ記録機能を実装
  - フィルタパラメータ（category、tag、query）もキャッシュに含め、リスト整合性を保証
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [ ] 2.1 DocumentListCacheを実装する
  - ドキュメント一覧ページの記事IDリスト（documentIds: number[]）をセッションストレージに保存
  - フィルタパラメータ（category、tag、query、sort）もキャッシュに含め、JSON形式でシリアライズ
  - 現在の記事IDとスワイプ方向（next/prev）から隣接記事IDを取得する機能を実装
  - リスト内で現在の記事インデックスを特定し、next時は+1、prev時は-1のインデックスの記事IDを返す
  - リスト端到達時（インデックスが範囲外）はnullを返し、ナビゲーション不可を示す
  - キャッシュ存在確認（hasCachedList）、クリア（clearCache）メソッドを実装
  - 記事IDリストの検証（空配列禁止、重複ID禁止、数値型チェック）を実装
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

### フェーズ2: ドキュメント一覧ページでのフォーカス移動機能

- [ ] 3. ドキュメント一覧ページでの記事カードフォーカス管理機能を実装する
  - ページ読み込み時に先頭カードに初期フォーカスを設定する機能を実装
  - スワイプ方向に応じて次/前のカードにフォーカスを移動する機能を実装
  - フォーカスされたカードにハイライトクラスを追加し、前のカードからハイライトを削除
  - フォーカスカードをビューポート内にスムーズにスクロール（scrollIntoView）する機能を実装
  - リスト端でのスワイプ時にエッジインジケーターを表示し、移動不可を通知
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.5_

- [ ] 3.1 CardFocusManagerを実装する
  - 初期化時にドキュメント一覧ページの記事カード要素を取得し、先頭カードにフォーカス設定
  - 現在フォーカスされているカードのインデックスを内部状態として管理
  - moveFocus(direction: 'next' | 'prev')メソッドで次/前のカードにフォーカス移動
  - フォーカス移動時、前のカードから`focus-highlight`クラスを削除し、新しいカードに追加
  - フォーカスカードに対してscrollIntoView({ behavior: 'smooth', block: 'center' })を実行
  - リスト端でのフォーカス移動試行時、エッジインジケーターを表示し、フォーカスは維持
  - 常に1つのカードのみがフォーカス状態であることを保証（複数フォーカス禁止）
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 4.1, 4.2, 4.5_

- [ ] 3.2 ドキュメント一覧ページでのスワイプ統合を実装する
  - ドキュメント一覧ページ読み込み時、ViewportDetectorでモバイル環境判定を実行
  - モバイル環境の場合、記事IDリストをDOMから抽出しDocumentListCacheに保存
  - SwipeGestureDetectorを初期化し、ドキュメント一覧ページ全体をスワイプターゲットに設定
  - スワイプイベント検出時、CardFocusManagerのmoveFocus()を呼び出してフォーカス移動
  - デスクトップ環境の場合、スワイプ機能を無効化し、タッチイベントリスナーを登録しない
  - ウィンドウリサイズでモバイル⇔デスクトップ切り替え時、スワイプ機能を動的に有効化/無効化
  - _Requirements: 1.1-1.5, 2.1-2.5, 3.1-3.7, 4.1, 4.2_

### フェーズ3: 記事詳細モーダルでのナビゲーション機能

- [ ] 4. 記事詳細モーダルでのスワイプナビゲーション機能を実装する
  - モーダル表示時、現在の記事IDを設定し、DocumentListCacheから隣接記事IDを取得可能にする
  - スワイプ検出時、次/前の記事IDを取得し、存在する場合はHTMXで新しい記事コンテンツを取得
  - HTMX部分更新でモーダル内コンテンツのみを更新し、モーダル自体は開いたままにする
  - ブラウザ履歴に新しい記事URLをプッシュ（history.pushState）し、ブラウザバック対応
  - ページタイトルを新しい記事タイトルに更新し、ブラウザタブ表示を同期
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.7, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 4.1 ModalNavigationManagerを実装する
  - 現在の記事IDを内部状態として管理し、setCurrentDocumentId()で設定
  - navigateToAdjacentDocument(direction)メソッドで次/前の記事への遷移を実行
  - DocumentListCacheから隣接記事IDを取得し、存在しない場合はエラーハンドリング
  - htmx.ajax()でHTMXリクエストをプログラマティックに発行し、記事詳細コンテンツを取得
  - レスポンス成功時、モーダル内の記事詳細エリア（target: '#modal-content'）を更新
  - history.pushState()で新しい記事URLをブラウザ履歴に追加し、hx-push-url相当の動作を実現
  - document.titleを新しい記事タイトルに更新し、ブラウザタブ表示を同期
  - ナビゲーション中フラグを管理し、連続スワイプによる重複リクエストを防止（デバウンス200ms）
  - モーダルクローズ時、ナビゲーション機能を無効化し、イベントリスナーをクリーンアップ
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.7, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 4.2 記事詳細モーダルでのスワイプ統合を実装する
  - モーダル表示時、モバイル環境判定を実行し、モバイルの場合のみスワイプ機能を有効化
  - モーダル内の記事詳細エリアをスワイプターゲットとして設定
  - SwipeGestureDetectorを初期化し、モーダル内スワイプイベントを監視
  - スワイプ検出時、ModalNavigationManagerのnavigateToAdjacentDocument()を呼び出し
  - 記事遷移成功時、ModalNavigationManagerを再初期化し、新しい記事IDを設定
  - モーダルクローズ時、スワイプイベントリスナーをクリーンアップし、メモリリーク防止
  - _Requirements: 1.1-1.5, 2.1-2.5, 3.1-3.7, 5.1-5.5_

### フェーズ4: UI/UXフィードバックとアクセシビリティ

- [ ] 5. スワイプ操作中の視覚的フィードバック機能を実装する
  - スワイプ開始時、スワイプ方向を示すインジケーター（矢印アイコン）を表示
  - スワイプ継続中、スワイプ距離に応じてインジケーターの透明度とサイズを動的に変化
  - スワイプ距離が移動閾値（100px）に達した時、インジケーター色を変更し移動可能状態を示す
  - スワイプ終了時、インジケーターをフェードアウトアニメーションで非表示
  - リスト端到達時、「これ以上移動できません」メッセージをインジケーターに表示
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 7.1, 7.2_

- [ ] 5.1 SwipeIndicatorを実装する
  - スワイプ方向（left/right）に応じた矢印アイコン（Lucide Icons）を表示するインジケーター要素を生成
  - show(direction)メソッドでインジケーターを表示し、初期状態（opacity: 0.3、scale: 0.5）を設定
  - update(distance, threshold)メソッドでスワイプ距離に応じてスタイルを更新（opacity: 0.3→1.0、scale: 0.5→1.0）
  - スワイプ距離が移動閾値（100px）に達した時、インジケーター色をgray→emeraldに変更
  - requestAnimationFrameを使用し、滑らかなアニメーション更新を実現
  - hide()メソッドでインジケーターをフェードアウトし、アニメーション完了後にDOMから削除
  - showError(message)メソッドでリスト端到達時のエラー状態を表示（x-circleアイコン、赤色）
  - 表示中のインジケーターは常に1つのみで、複数同時表示を禁止
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 7.1, 7.2_

- [ ] 5.2 アクセシビリティ対応を実装する
  - スワイプインジケーターにrole="status"とaria-live="polite"を設定
  - ナビゲーション完了時、スクリーンリーダーに新しい記事タイトルを通知（aria-live領域に挿入）
  - キーボードナビゲーションサポート（左右矢印キーで記事移動）を実装
  - 代替ナビゲーションボタン（前へ/次へボタン）を提供し、タッチ操作不可環境でも利用可能にする
  - ARIA属性がWCAG 2.1 AAレベルに準拠していることを確認
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ] 5.3 AriaManagerを実装する
  - setIndicatorAriaAttributes(element, state)メソッドでインジケーターにARIA属性を設定
  - スワイプ状態（active/success/error）に応じてaria-live優先度を調整（polite/assertive）
  - announceNavigation(documentTitle)メソッドでナビゲーション完了をスクリーンリーダーに通知
  - aria-live領域を動的に生成し、通知テキストを挿入後、一定時間で削除
  - enableAlternativeNavigation()メソッドで代替ナビゲーションボタンをDOM挿入し、キーボードフォーカス可能に設定
  - 左右矢印キーイベントリスナーを登録し、キーボードナビゲーションを実現
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

### フェーズ5: エラーハンドリングとパフォーマンス最適化

- [ ] 6. エラーハンドリングとフォールバック機能を実装する
  - ネットワークエラー発生時、エラートースト通知を表示し、最大3回までリトライ
  - 記事IDがリスト内に存在しない場合、スワイプ機能を無効化し、警告ログを出力
  - スワイプ操作中のJavaScriptエラーをキャッチし、デフォルトのスクロール動作にフォールバック
  - リスト取得API失敗時、スワイプ機能を無効化し、通常のタップナビゲーションにフォールバック
  - エラー状態が継続する場合、一定回数（3回）のリトライ後、完全に無効化
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 6.1 ErrorHandlerを実装する
  - handleError(error: NavigationError)メソッドでエラータイプに応じた処理を分岐
  - NO_ADJACENT_DOCUMENTエラー時、SwipeIndicatorでリスト端インジケーター表示のみ
  - NETWORK_ERRORエラー時、トースト通知表示とリトライ処理を実行（最大3回、指数バックオフ1秒、2秒、4秒）
  - NO_CACHEエラー時、スワイプ機能を無効化し、警告ログ出力
  - SERVER_ERRORエラー時、1回のみリトライし、失敗時はエラー通知表示
  - DOCUMENT_NOT_FOUNDエラー時、DocumentListCacheから該当記事IDを削除し、次の隣接記事へスキップ
  - retry(operation, maxRetries)メソッドで汎用的なリトライ処理を実装
  - logError(error)メソッドでエラーログをconsole.errorに出力し、タイムスタンプとスタックトレースを記録
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 7. パフォーマンス最適化を実装する
  - スワイプジェスチャー検出から視覚的フィードバック開始までの時間を50ms以内に最適化
  - 記事遷移開始からコンテンツ取得リクエスト発行までの時間を300ms以内に最適化
  - コンテンツ取得中、ローディングインジケーターを表示し、ユーザーに待機状態を通知
  - 新しい記事読み込み時、コンテンツ描画完了までの時間を500ms以内に最適化
  - デバウンス処理（200ms）で複数回のスワイプによる重複リクエストを防止
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 7.1 パフォーマンス計測とチューニングを実装する
  - performance.now()でスワイプ検出、フィードバック開始、リクエスト発行、描画完了のタイムスタンプを記録
  - 各フェーズの時間を計測し、目標値（50ms、300ms、500ms）を超えた場合は警告ログ出力
  - requestAnimationFrameでインジケーター更新を最適化し、60fps維持を目指す
  - デバウンス処理でリサイズイベントとスワイプイベントの連続発火を制御（200ms）
  - メモリリーク防止のため、イベントリスナーのクリーンアップを徹底（モーダルクローズ時、ページ遷移時）
  - 連続20回のスワイプ操作後、メモリ使用量をチェックし、リークがないことを確認
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

### フェーズ6: テスト実装

- [ ] 8. ユニットテストを実装する
  - ViewportDetectorのモバイル環境判定ロジックをテスト（768px閾値）
  - SwipeGestureDetectorのスワイプ距離計算と方向判定ロジックをテスト
  - DocumentListCacheの隣接記事ID取得ロジックをテスト（next/prev、リスト端処理）
  - CardFocusManagerのフォーカス移動ロジックをテスト（ハイライトクラス追加/削除）
  - ModalNavigationManagerのHTMXリクエスト発行とURL更新ロジックをテスト
  - _Requirements: すべての要件（ユニットレベル）_

- [ ] 8.1 統合テストを実装する
  - ドキュメント一覧ページでのスワイプフォーカス移動フロー全体を統合テスト
  - 記事詳細モーダルでのスワイプナビゲーションフロー全体を統合テスト
  - モバイル環境判定とスワイプ有効化/無効化の動的切り替えをテスト
  - セッションストレージキャッシュの保存/読み込み/クリアをテスト
  - エラーハンドリングフローとリトライ処理を網羅的にテスト
  - _Requirements: すべての要件（統合レベル）_

- [ ] 8.2 E2Eテスト（Playwright）を実装する
  - ドキュメント一覧ページでの左右スワイプによるフォーカス移動をE2Eテスト
  - フォーカスカードタップで記事詳細モーダル表示をE2Eテスト
  - モーダル内での右スワイプで次の記事に遷移し、タイトル変更を確認
  - モーダル内での左スワイプで前の記事に戻り、タイトル変更を確認
  - リスト端でのスワイプ時にエッジインジケーター表示を確認
  - スワイプ中のインジケーター表示（opacity、scale、色変化）を確認
  - ネットワークエラーシミュレーション時のリトライ処理とトースト通知を確認
  - ARIA属性の正常設定とスクリーンリーダー通知を確認
  - _Requirements: すべての要件（E2Eレベル）_

### フェーズ7: 統合とドキュメント

- [ ] 9. 既存システムとの統合を完了する
  - ドキュメント一覧ページテンプレート（documents.html）にスワイプ機能初期化スクリプトを追加
  - 記事詳細モーダルテンプレート（partials/modal_content.html）にスワイプ機能初期化スクリプトを追加
  - 既存のHTMX部分更新ロジックとスワイプナビゲーションを整合させ、競合を回避
  - 既存のモーダル表示JavaScript（modal.js）とスワイプ機能を統合
  - Tailwind CSSでスワイプインジケーターのスタイリングを実装（既存クラス活用）
  - _Requirements: すべての要件（統合レベル）_

- [ ] 9.1 JavaScriptファイル配置と読み込みを最適化する
  - app/static/js/swipe-navigation.jsとして新規スワイプ機能モジュールを作成
  - ViewportDetector、SwipeGestureDetector、DocumentListCache、CardFocusManager、ModalNavigationManager、SwipeIndicator、AriaManager、ErrorHandlerをモジュール内に実装
  - documents.htmlとmodal_content.htmlから適切にスクリプトを読み込み、初期化関数を呼び出し
  - 既存のhtmx-minimal.jsとの競合を回避し、HTMX部分更新完了後にスワイプ機能を再初期化
  - minify化されたJavaScriptファイルを本番環境用に生成（オプション）
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 9.2 CSSスタイルとインジケーターデザインを実装する
  - スワイプインジケーター用のTailwind CSSクラスを定義（app/static/css/style.css）
  - インジケーター表示アニメーション（フェードイン/フェードアウト）をCSSで実装
  - フォーカスカード用のハイライトクラス（focus-highlight）を定義し、境界線とシャドウを追加
  - モバイル環境でのタッチ操作最適化（touch-action: pan-y）をCSSで設定
  - 既存のグローバルボタンスタイルとの競合を回避し、インジケーター用ボタンはインラインスタイルで上書き
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

## タスク要約

- **総タスク数**: 9個のメジャータスク、21個のサブタスク
- **推定工数**: 各サブタスク1-3時間、合計約40-60時間
- **要件カバレッジ**: 全8要件（1.1-8.5）すべてカバー

## 実装順序の根拠

1. **フェーズ1**: 基盤実装（環境判定、スワイプ検出、キャッシュ）で、後続フェーズの前提を確立
2. **フェーズ2**: ドキュメント一覧ページでのフォーカス移動で、シンプルなUI操作から開始
3. **フェーズ3**: 記事詳細モーダルでのナビゲーションで、HTMX統合を含む複雑な機能を実装
4. **フェーズ4**: UI/UXフィードバックで、視覚的フィードバックとアクセシビリティを追加
5. **フェーズ5**: エラーハンドリングで、堅牢性を確保
6. **フェーズ6**: テストで、品質を保証
7. **フェーズ7**: 統合とドキュメントで、既存システムとの整合性を確認し、リリース準備完了

## 次のステップ

タスク承認後、`/kiro:spec-impl mobile-swipe-navigation 1.1`で実装を開始してください。
