# 実装計画

## 概要
この実装計画は、記事詳細をポップアップ（モーダル）表示に変更し、記事一覧からの操作性を大幅に改善する機能を段階的に実装するためのタスクリストです。HTMX + サーバーサイドレンダリングのアーキテクチャパターンを踏襲し、既存のScrap-Boardの技術スタックに整合する形で実装を進めます。

---

- [ ] 1. モーダル基盤の構築と基本的な表示機能の実装
- [x] 1.1 モーダルコンテナとオーバーレイの追加
  - ベーステンプレート（`base.html`または`documents.html`）にモーダルコンテナDOMノードを追加
  - モーダルの表示/非表示を制御するTailwind CSSクラスを設定
  - オーバーレイ用のスタイル（半透明の黒背景、z-index設定）を定義
  - ARIA属性（`role="dialog"`, `aria-modal="true"`, `aria-labelledby`）を設定してアクセシビリティを確保
  - _Requirements: 1.2, 1.3, 7.4_

- [x] 1.2 部分テンプレートの作成と記事詳細コンテンツのレンダリング
  - 既存の`document_detail.html`から記事詳細表示部分を抽出
  - モーダル用の部分テンプレート`partials/modal_content.html`を新規作成
  - ヘッダー（タイトル、閉じるボタン）、コンテンツ（本文、メタデータ）、フッター（アクションボタン）の3セクション構造を実装
  - Markdown表示、サムネイル画像、カテゴリ/タグ、公開日、ソース情報を表示
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 1.3 モーダルコンテンツ取得APIエンドポイントの実装
  - FastAPIで新規エンドポイント`GET /api/documents/{id}/modal`を作成
  - データベースから記事データを取得し、存在確認を実施
  - ブックマーク状態を付与して`modal_content.html`をレンダリング
  - 404エラーハンドリングを実装（記事が存在しない場合）
  - _Requirements: 1.1, 3.1_

- [x] 1.4 記事カードのモーダルトリガーHTMX統合
  - `partials/document_card.html`の「詳細を見る」リンクにHTMX属性を追加
  - `hx-get="/api/documents/{id}/modal"`でモーダルコンテンツを取得
  - `hx-target="#modal-container"`でモーダルコンテナに挿入
  - `onclick="event.preventDefault()"`でデフォルトのページ遷移を防止
  - _Requirements: 1.1_

---

- [x] 2. モーダルの操作とインタラクション機能の実装
- [x] 2.1 JavaScript状態管理モジュールの作成
  - `app/static/js/modal.js`を新規作成
  - モーダルの開閉関数（`openModal()`, `closeModal()`）を実装
  - 背景スクロールの無効化/復元機能を実装（`document.body.style.overflow`制御）
  - モーダルコンテナの表示/非表示をCSSクラス（`hidden`）で切り替え
  - _Requirements: 1.4, 2.4_

- [x] 2.2 閉じる操作のイベントハンドリング実装
  - 閉じるボタン（×アイコン）のクリックイベントリスナーを追加
  - 背景オーバーレイのクリックイベントで`closeModal()`を呼び出し
  - ESCキーの`keydown`イベントリスナーでモーダルを閉じる機能を実装
  - イベントバブリングを考慮して、モーダル内部のクリックでは閉じないようにする
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 2.3 キーボードフォーカス管理とアクセシビリティ対応
  - モーダル表示時に前回のフォーカス位置を保存
  - モーダル内の最初のフォーカス可能要素（ボタン、リンク）にフォーカスを移動
  - フォーカストラップ（`Tab`キーでモーダル内をループ）を実装
  - モーダル閉じる際に、元の記事カードのボタンにフォーカスを復元
  - _Requirements: 7.2, 7.3, 7.5_

---

- [ ] 3. URL履歴管理とディープリンク対応
- [ ] 3.1 HTMX URL履歴統合とブラウザ履歴への記録
  - 記事カードのリンクに`hx-push-url="/documents?doc={id}"`を追加
  - モーダルを開いた際にURLにクエリパラメータ`?doc={id}`を追加
  - HTMX `afterSwap`イベントリスナーで`openModal()`を自動的に呼び出し
  - _Requirements: 6.1_

- [ ] 3.2 ブラウザの戻るボタン対応とpopstateイベント処理
  - `window.addEventListener('popstate')`でブラウザ履歴の変更を監視
  - URLから`?doc={id}`パラメータが削除された場合に`closeModal()`を呼び出し
  - モーダル閉じる際に`history.pushState()`でURLからパラメータを削除
  - _Requirements: 6.2, 6.4_

- [ ] 3.3 ディープリンク対応とページロード時の自動モーダル表示
  - `DOMContentLoaded`イベントでURLクエリパラメータを確認
  - `?doc={id}`が存在する場合、HTMX `ajax()`で自動的にモーダルコンテンツを取得
  - モーダルが開いた状態で一覧ページを表示
  - _Requirements: 6.3_

---

- [ ] 4. ブックマーク機能のモーダル統合とUI同期
- [ ] 4.1 モーダル内のブックマークボタンUI実装
  - `modal_content.html`にブックマークボタンを追加
  - ブックマーク済み状態とブックマーク解除状態の表示切り替え
  - HTMX `hx-post="/api/bookmarks"`でブックマーク追加を実行
  - HTMX `hx-delete="/api/bookmarks?document_id={id}"`でブックマーク削除を実行
  - _Requirements: 4.1, 4.2_

- [ ] 4.2 ブックマークAPIのout-of-band swap対応
  - `/api/bookmarks`エンドポイントに`HX-Request`ヘッダーの検出ロジックを追加
  - HTMX リクエストの場合、複数のHTML断片（モーダルボタン + 記事カード）を返却
  - `hx-swap-oob="true"`属性を使用してモーダルとカードの両方を更新
  - 非HTMXリクエスト（APIテスト等）の場合はJSON応答を返却して後方互換性を維持
  - _Requirements: 4.3, 4.4_

- [ ] 4.3 部分テンプレートの切り出しとブックマーク状態の再利用
  - ブックマークボタンを部分テンプレート`partials/bookmark_button.html`として切り出し
  - モーダル用と記事カード用のコンテキスト引数（`context="modal"`または`context="card"`）を追加
  - ブックマーク済みバッジを部分テンプレート`partials/bookmark_badge.html`として切り出し
  - 両方のテンプレートで同じHTML構造を共有し、重複を削減
  - _Requirements: 4.4_

---

- [ ] 5. レスポンシブデザインとモバイル対応
- [ ] 5.1 デスクトップ向けモーダルスタイリング
  - Tailwindクラスでデスクトップ画面（幅768px以上）のスタイルを定義
  - 最大幅800px、画面中央配置、適切な余白とボーダー半径を設定
  - 背景オーバーレイの半透明黒色（`bg-black/40`）を適用
  - _Requirements: 5.1_

- [ ] 5.2 モバイル向けフルスクリーンモーダル対応
  - Tailwindレスポンシブクラス（`md:`プレフィックス）で画面サイズを判定
  - モバイル画面（幅768px未満）では`w-full h-full`でフルスクリーン表示
  - デスクトップでは`max-w-4xl mx-auto my-8`で中央配置と余白を確保
  - _Requirements: 5.2_

- [ ] 5.3 モーダル内スクロールとオーバーフロー制御
  - モーダルコンテンツ部分に`max-h-[70vh] overflow-y-auto`を適用
  - 長い記事でもモーダル内でスクロール可能にする
  - 背景の記事一覧はスクロールを無効化（`body.style.overflow = 'hidden'`）
  - _Requirements: 5.3, 5.4_

---

- [ ] 6. エラーハンドリングとフォールバック処理
- [ ] 6.1 404エラー時のモーダル内エラー表示
  - モーダルコンテンツ取得APIで記事が存在しない場合の404エラーをハンドリング
  - エラー専用の部分テンプレート`partials/error_modal.html`を作成
  - 記事が見つかりませんメッセージとアイコンを表示
  - 閉じるボタンでモーダルを閉じられるようにする
  - _Requirements: エラーハンドリング戦略_

- [ ] 6.2 ネットワークエラー時のトーストメッセージ表示
  - HTMX `htmx:responseError`イベントリスナーを追加
  - ネットワークエラー、タイムアウト発生時にエラートーストを表示
  - モーダルが開けなかった場合は従来の詳細ページにフォールバック（`window.location.href = '/documents/{id}'`）
  - _Requirements: エラーハンドリング戦略_

- [ ] 6.3 DOM構造エラー時のフォールバック処理
  - `modal.js`でモーダルコンテナの存在確認を実施
  - 要素が見つからない場合はコンソールエラーログを出力し、従来のページ遷移にフォールバック
  - エラーログに詳細情報（期待されるDOM要素ID、エラー内容）を記録
  - _Requirements: エラーハンドリング戦略_

---

- [ ] 7. テストとパフォーマンス検証
- [ ] 7.1 ユニットテスト: モーダルAPIエンドポイント
  - `tests/test_modal_api.py`を新規作成
  - 正常系: 記事詳細の取得（200 OK、HTML応答）
  - 異常系: 存在しない記事ID（404エラー）
  - 正常系: ブックマーク追加のout-of-band swap（複数のHTML断片）
  - 正常系: ブックマーク削除とUI更新
  - エッジケース: ブックマーク重複追加の防止
  - _Requirements: 7.1_

- [ ] 7.2 E2Eテスト: モーダルUI操作フロー
  - `tests/test_modal_ui.py`を新規作成
  - 正常系: 記事カードからモーダルを開く
  - 正常系: モーダル内でブックマーク操作を実行
  - 正常系: ×ボタン、背景クリック、ESCキーでモーダルを閉じる
  - 正常系: ディープリンク（`/documents?doc=123`）でモーダルを自動的に開く
  - 正常系: ブラウザの戻るボタンでモーダルを閉じる
  - _Requirements: 7.1_

- [ ] 7.3 パフォーマンステスト: モーダル表示速度
  - モーダル表示速度が500ms以内であることを検証
  - ブックマーク操作の応答性が200ms以内であることを検証
  - Playwrightのタイミング測定機能を使用
  - _Requirements: 7.1_

---

- [ ] 8. 統合と最終調整
- [ ] 8.1 既存の記事詳細ページとの統合確認
  - 既存の`/documents/{id}`エンドポイントが正常に動作することを確認
  - 直接アクセスやブックマークからのアクセスが従来通り機能することを検証
  - モーダル優先のアクセスパターンと従来のページ遷移の共存を確認
  - _Requirements: 後方互換性_

- [ ] 8.2 類似記事の遅延読み込み統合
  - モーダル内の類似記事セクションにHTMX `hx-get="/api/documents/{id}/similar"`を追加
  - `hx-trigger="load"`で遅延読み込みを実装
  - ローディングインジケーターを表示して、ユーザーに読み込み中であることを伝える
  - _Requirements: 3.5_

- [ ] 8.3 全体的な統合テストとリグレッションテスト
  - 既存のE2Eテストがすべてパスすることを確認
  - モーダル機能が他の機能（検索、フィルタリング、パーソナライズドランキング等）に影響しないことを検証
  - ブックマーク、コレクション、エクスポート等の既存機能が正常に動作することを確認
  - _Requirements: 全要件_
