# 実装タスク

## タスク概要

記事詳細モーダルをモバイル画面（768px以下）でも快適に閲覧できるようレスポンシブ対応を実装します。既存のHTMXベースのモーダル機構を維持しながら、CSSとHTML属性の調整のみでレスポンシブ化を実現します。

---

- [x] 1. モバイル画面でのモーダルレイアウト基盤を構築する
  - モーダルダイアログのコンテナ要素に対して、モバイル画面で全画面幅を使用し、デスクトップでは最大幅を制限するレスポンシブクラスを適用する
  - モーダルの高さをビューポートに合わせて調整し、モバイルでは画面全体を使用し、デスクトップでは最大高さ85vhに制限する
  - モーダルのヘッダ、コンテンツ、フッターがflexboxで縦方向に配置され、コンテンツ部分が伸縮可能な領域として機能するようにする
  - 横方向のオーバーフローを防ぐために、すべての子要素に最大幅の制限を適用する
  - _Requirements: 1.1, 1.2, 6.1_

- [x] 2. モーダルヘッダのレスポンシブ対応を実装する
- [x] 2.1 ヘッダのパディングとフォントサイズをモバイル向けに最適化する
  - ヘッダのパディングをモバイル画面では `p-4`（1rem）に削減し、デスクトップでは `p-6`（1.5rem）を維持するTailwindレスポンシブクラスを適用する
  - タイトルのフォントサイズをモバイル画面ではメディアクエリを使用して `1rem` に削減し、行間を `1.2` に調整する
  - メタデータバッジ（公開日、ソース名など）のフォントサイズをモバイル画面では `text-xs`（0.75rem）に削減する
  - _Requirements: 3.1, 3.2, 6.2_

- [x] 2.2 ヘッダ内の要素間隔と高さを最適化する
  - ヘッダ内のタイトル、メタデータ、閉じるボタンの要素間マージンを最小化し、縦積みレイアウトの高さを56px以内に抑える
  - 二次的なメタデータ（公開日、ソース名など）をモバイル画面では1行に要約し、必要に応じて `truncate` クラスで切り詰める
  - 閉じるボタンのサイズとパディングをモバイルでも44x44pxのタッチターゲットサイズを確保するよう調整する
  - _Requirements: 3.3, 3.4, 4.1_

- [x] 3. カテゴリとタグのラベル表示をレスポンシブ対応する
- [x] 3.1 ラベルの改行防止とオーバーフロー処理を実装する
  - カテゴリラベルとタグラベルに `white-space: nowrap` を適用し、ラベルテキストが複数行に折り返されないようにする
  - ラベルのテキスト長が親コンテナを超える場合に `text-overflow: ellipsis` と `overflow: hidden` を適用し、省略記号で切り詰める
  - ラベルの最大幅をモバイル画面では `max-width: 150px` に制限するカスタムCSSルールを追加する
  - _Requirements: 2.1, 2.2_

- [x] 3.2 ラベルの完全なテキストをアクセシブルに表示する
  - 切り詰められたラベルに `title` 属性を追加し、マウスホバーまたはロングタップで完全なテキストを表示できるようにする
  - スクリーンリーダー向けに `aria-label` 属性を追加し、視覚的に切り詰められたテキストも音声で完全に読み上げられるようにする
  - ラベルコンテナに `flex-wrap: wrap` を適用し、複数のラベルが次の行に折り返すが、個々のラベル内では改行しないようにする
  - _Requirements: 2.3, 2.4, 4.3_

- [x] 4. モーダルコンテンツ領域のスクロール動作を最適化する
  - コンテンツ領域のパディングをモバイル画面では `p-4`（1rem）に削減し、デスクトップでは `p-6`（1.5rem）を維持する
  - スクロール可能な領域に `-webkit-overflow-scrolling: touch` を適用し、iOS での慣性スクロールを有効化する
  - モーダルが開いている間、背景のスクロールがロックされることを確認する（既存の `modal.js` の動作を維持）
  - モーダル内のサムネイルや画像に `max-w-full`, `h-auto` を適用し、画面幅に応じて縮小されることを確認する
  - _Requirements: 1.3, 1.4, 4.2_

- [x] 5. モーダルフッターのレスポンシブ対応を実装する
  - フッターのパディングをモバイル画面では `p-4`（1rem）に削減し、デスクトップでは `p-6`（1.5rem）を維持する
  - フッター内のボタンとリンクに最低44x44pxのタッチターゲットサイズを確保するカスタムCSSルールを追加する
  - ボタンのパディングをモバイル画面では `padding: 0.5rem 0.75rem` に調整し、デスクトップのパディングは維持する
  - _Requirements: 4.1, 6.2_

 [x] 6. カスタムCSSにレスポンシブスタイルを追加する
  - `app/static/css/style.css` の末尾に「Modal Responsive Styles」セクションを新規追加する
  - `@media (max-width: 768px)` メディアクエリ内に、モバイル専用のスタイルルールを定義する
  - すべてのセレクタを `[data-modal-dialog]` でスコープし、グローバルスタイルとの競合を防止する
  - `!important` 宣言を使用する箇所には、その理由をコメントで明記する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

 [x] 7. パフォーマンス最適化とGPU加速を実装する
  - モーダルダイアログに `will-change: transform, opacity` を適用し、GPUレイヤーに分離する
  - モーダルダイアログに `transform: translateZ(0)` を適用し、ハードウェアアクセラレーションを有効化する
  - アニメーションとトランジションには `transform` と `opacity` を優先し、`width` や `height` の変更を避ける
  - ブラウザのリフローを引き起こす可能性のあるスタイル変更を最小限に抑える
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 8. アクセシビリティとキーボード操作を確保する
  - すべてのタップ可能要素（ボタン、リンク）にフォーカススタイル（`outline: 2px solid #3b82f6`, `outline-offset: 2px`）を追加する
  - キーボードフォーカスがモーダル内の要素に移動したときに、視覚的なインジケーターが表示されることを確認する
  - 既存の `modal.js` のフォーカストラップ機能が正常に動作することを確認する（変更不要）
  - スクリーンリーダー向けのARIA属性（`aria-label`, `title`）が正しく設定されていることを確認する
  - _Requirements: 4.3, 4.4_

- [ ] 9. E2Eテストでモバイル画面のレイアウトを検証する
 - [x] 9. E2Eテストでモバイル画面のレイアウトを検証する
 - [x] 9.1 モバイル画面でのモーダル表示テストを作成する
  - `tests/test_document_modal_responsive_ui.py` を新規作成する
  - ビューポートを375x667（iPhone SE）に設定し、記事カードをクリックしてモーダルを開くテストを実装する
  - 横スクロールが発生しないこと（`document.body.scrollWidth <= 375`）を検証する
  - ヘッダの高さが56px以内であることを検証する
  - スクリーンショットを取得し、視覚的な回帰テストのベースラインとする
  - _Requirements: 1.1, 3.3_

 - [x] 9.2 ラベルの改行防止とツールチップ表示テストを作成する
  - 長いカテゴリ名またはタグ名を持つ記事でモーダルを開き、ラベルが省略記号で切り詰められていることを検証する
  - ラベル要素の `title` 属性が設定されていることを検証する
  - ラベルの `scrollWidth` が `clientWidth` より大きい場合にオーバーフローが正しく処理されていることを確認する
  - _Requirements: 2.2, 2.3_

 - [x] 9.3 タッチターゲットサイズテストを作成する
  - モバイル画面でモーダル内のすべてのボタンとリンクの `bounding_box` を取得する
  - すべてのタップ可能要素の幅と高さが44px以上であることを検証する
  - _Requirements: 4.1_

 - [x] 9.4 デスクトップ互換性テストを作成する
  - ビューポートを1920x1080に設定し、既存のE2Eテスト（`test_document_modal_ui.py`）がパスすることを確認する
  - ヘッダのパディングが `p-6`（24px）であることを `window.getComputedStyle` で検証する
  - デスクトップ画面でのレイアウトが既存の実装と変わらないことをスクリーンショットで比較する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 10. パフォーマンステストと最終検証を実施する
  - Lighthouse をモバイルモードで実行し、Performance スコアが90以上であることを確認する
  - Chrome DevTools の Performance タブでスクロール時のフレームレートが60fps以上であることを確認する
  - モーダルの初回表示が300ms以内に完了することを `performance.now()` で測定する
  - CSS ファイルサイズの増加が2KB以内に収まっていることを確認する
  - _Requirements: 7.1, 7.2_

---

## 実装の前提条件

- 既存の `app/templates/partials/modal_content.html` のHTML構造を理解している
- 既存の `app/static/js/modal.js` のモーダル開閉ロジックを変更しない
- 既存の `app/static/css/style.css` のグローバルスタイルとの競合を回避する
- Tailwind CSS のレスポンシブプレフィックス（`md:`, `sm:`）の使用方法を理解している

## 実装後の検証項目

- [ ] モバイル画面（375x667）でモーダルを開いたときに、横スクロールが発生しない
- [ ] モバイル画面でヘッダの高さが56px以内に収まっている
- [ ] カテゴリとタグのラベルが意図しない改行をせず、必要に応じて省略記号で切り詰められている
- [ ] 切り詰められたラベルにマウスホバーまたはロングタップすると、完全なテキストが表示される
- [ ] モバイル画面ですべてのボタンとリンクが44x44px以上のタッチターゲットサイズを持っている
- [ ] モーダル内でスクロールがスムーズに動作し、慣性スクロールが有効化されている
- [ ] デスクトップ画面（1920x1080）での表示が既存の実装と変わらない
- [ ] 既存のE2Eテスト（`test_document_modal_ui.py`）がすべてパスする
- [ ] Lighthouse のPerformance スコアが90以上である
- [ ] スクロール時のフレームレートが60fps以上である
