{% set container_target = container_target if container_target is defined else '#documents-container' %}
<article tabindex="0" class="w-full bg-white rounded-xl border border-mist shadow-sm hover:shadow-lg transition-shadow hover:-translate-y-1 transform will-change-transform p-4 flex flex-col h-full card-edge my-3">
    <header class="flex items-start gap-4 flex-wrap">
        <img src="{% if document.thumbnail_url %}/data/{{ document.thumbnail_url }}{% else %}/static/images/default-thumbnail.svg{% endif %}?v={{ document.updated_at.isoformat() if document.updated_at else '1' }}" alt="thumbnail" loading="lazy" class="w-12 h-12 md:w-16 md:h-16 thumb-80 rounded-md object-cover flex-shrink-0" />
        <div class="flex-1 min-w-0">
            {% if document.created_at %}
                <div class="doc-date text-xs text-gray-400 mb-1">
                    {{ document.created_at|to_jst('%Y年%m月%d日') }}
                    <span class="ml-2 text-xs text-gray-400">{{ document.created_at|to_jst('%H:%M') }}</span>
                </div>
            {% endif %}
            <a href="/documents/{{ document.id }}" class="text-lg font-semibold text-ink hover:text-emerald transition-colors block break-words">{{ document.title }}</a>
            <div class="mt-1 text-xs text-gray-400 truncate flex items-center gap-2">
                {% if document.source %}
                    <span class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs">{{ '手動' if document.source == 'manual' else document.source }}</span>
                {% endif %}
                {% if document.domain %}
                    <span class="inline-block truncate max-w-[12rem]">{{ document.domain }}</span>
                    {% if document.url %}
                        <a href="{{ document.url }}" target="_blank" rel="noopener noreferrer" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist">
                            <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                            元記事
                        </a>
                    {% endif %}
                {% else %}
                    {% if document.url %}
                        <a href="{{ document.url }}" target="_blank" rel="noopener noreferrer" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist">
                            <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                            元記事
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </header>

    <div class="mt-4 pt-4 border-t border-dashed border-mist documents-divider-dashed flex-1">
        {% if document.short_summary %}
            <p class="mb-2">
                <span class="pill nowrap-tag mr-2 inline-flex items-center h-6 px-2 text-xs" style="background-color:#f5f3ff;color:#6b21a8;border-color:rgba(107,33,168,0.12)">要約</span>
            </p>
            <p class="text-sm text-graphite leading-relaxed break-words max-h-[7.5rem] overflow-auto" data-md-inline="{{ document.short_summary|e }}"></p>
            {% if not ns.autostart_done %}
                <span data-md-autostart="true" data-md="{{ document.short_summary|e }}" data-title="{{ document.title|e }}" class="hidden"></span>
                {% set ns.autostart_done = true %}
            {% endif %}
        {% else %}
            <p class="text-sm text-graphite leading-relaxed break-words max-h-[7.5rem] overflow-auto" data-md-inline="{{ (document.content_text[:300] ~ ('...' if document.content_text|length > 300 else ''))|e }}"></p>
        {% endif %}
    </div>

    <footer class="mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
        <div class="flex items-center gap-2 flex-wrap max-w-full">
            {% if document.classifications %}
                {% set cat = document.classifications[0].primary_category %}
                <span class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs {{ category_class_map.get(cat, 'bg-mist text-graphite') }}">
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    {{ cat }}
                </span>
                {% if document.classifications[0].tags %}
                    {% set all_tags = document.classifications[0].tags %}
                    {% set display_limit = 5 %}
                    {% for t in all_tags[:display_limit] %}
                        <a
                            href="/documents?tag={{ t }}"
                            class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs {% if selected_tag and selected_tag == t %}{{ '' }}{% else %}bg-mist/80 text-graphite border border-mist{% endif %}"
                            {% if selected_tag and selected_tag == t %}style="background-color:#fff1f2;color:#9f1239;border-color:#fecdd3"{% endif %}
                            hx-get="/documents"
                            hx-vals='{"tag": "{{ t }}"}'
                            hx-target="{{ container_target }}"
                            hx-push-url="true"
                            title="{{ t }}でフィルタ"
                        >
                            {{ t }}
                        </a>
                    {% endfor %}

                    {% if all_tags|length > display_limit %}
                        <button type="button" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist tag-more-toggle" aria-expanded="false" title="残りのタグを表示">+{{ all_tags|length - display_limit }}</button>
                        <div class="tag-more-list hidden mt-2 flex gap-2 flex-wrap">
                            {% for t in all_tags[display_limit:] %}
                                <a
                                    href="/documents?tag={{ t }}"
                                    class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist"
                                    hx-get="/documents"
                                    hx-vals='{"tag": "{{ t }}"}'
                                    hx-target="{{ container_target }}"
                                    hx-push-url="true"
                                    title="{{ t }}でフィルタ"
                                >
                                    {{ t }}
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            {% endif %}
            <a href="/documents/{{ document.id }}" class="text-xs bg-emerald text-white px-3 py-1 rounded-md hover:bg-emerald/90">詳細を見る</a>
            <button
                class="bookmark-btn pill nowrap-tag inline-flex items-center h-6 px-2 text-xs ml-2 {% if not document.bookmarked %}bg-mist/80 text-graphite border border-mist{% endif %}"
                data-doc-id="{{ document.id }}"
                aria-pressed="{{ 'true' if document.bookmarked else 'false' }}"
                onclick="toggleBookmark(this)"
                title="ブックマーク"
                {% if document.bookmarked %}style="background-color:#fff1f2;color:#9f1239;border-color:#fecdd3"{% endif %}
            >
                <i data-lucide="heart" class="w-4 h-4 mr-2 {% if document.bookmarked %}text-rose-600{% else %}text-graphite{% endif %}" {% if document.bookmarked %}style="color: #9f1239;"{% endif %}></i>
                <span class="text-xs">ブックマーク</span>
            </button>
        </div>
    </footer>
</article>
