{% set container_target = container_target if container_target is defined else '#documents-container' %}
<article tabindex="0" class="w-full bg-white rounded-xl border border-mist shadow-sm hover:shadow-lg transition-shadow hover:-translate-y-1 transform will-change-transform p-4 flex flex-col h-full card-edge my-3" data-document-id="{{ document.id }}"
    {% if document.personalized_score is not none and document.personalized_components is not none %}
    data-personalized-score="{{ document.personalized_score }}"
    data-personalized-rank="{{ document.personalized_rank if document.personalized_rank is not none else '' }}"
    data-personalized-explanation="{{ document.personalized_explanation|e }}"
    data-personalized-components='{{ document.personalized_components.to_dict()|tojson|safe }}'
    data-personalized-computed-at="{{ document.personalized_computed_at.isoformat() }}"
    data-personalized-cold-start="{{ 'true' if document.personalized_cold_start else 'false' }}"
    {% endif %}
>
    <header class="flex items-start gap-4 flex-wrap">
        <img src="{% if document.thumbnail_url %}/data/{{ document.thumbnail_url }}{% else %}/static/images/default-thumbnail.svg{% endif %}?v={{ document.updated_at.isoformat() if document.updated_at else '1' }}" alt="thumbnail" loading="lazy" class="w-12 h-12 md:w-16 md:h-16 thumb-80 rounded-md object-cover flex-shrink-0" />
        <div class="flex-1 min-w-0">
            {% set bookmark_dt = document.bookmark_created_at if document.bookmark_created_at else document.created_at %}
            {% if bookmark_dt %}
                <div class="doc-date text-xs text-gray-500 mb-1 flex items-center gap-2">
                    <span class="inline-flex items-center px-2 py-0.5 bg-mist text-graphite rounded-full text-[11px]">ブックマーク</span>
                    <span>{{ bookmark_dt|to_jst('%Y年%m月%d日') }}</span>
                    <span class="text-gray-400">{{ bookmark_dt|to_jst('%H:%M') }}</span>
                </div>
            {% endif %}
            <a href="/documents/{{ document.id }}" class="text-lg font-semibold text-ink hover:text-emerald transition-colors block break-words">{{ document.title }}</a>
            <div class="mt-1 text-xs text-gray-400 truncate flex items-center gap-2">
                {% if document.source %}
                    <span class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs">{{ '手動' if document.source == 'manual' else document.source }}</span>
                {% endif %}
                    {% if document.domain %}
                    <span class="inline-block truncate max-w-[12rem]">{{ document.domain }}</span>
                    {% if document.url %}
                        <a href="{{ document.url }}" target="_blank" rel="noopener noreferrer" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist">
                            <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                            元記事
                        </a>
                        {% if document.pdf_path %}
                        <a href="/api/documents/{{ document.id }}/pdf" download title="PDFをダウンロード" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 transition-colors">
                            <i data-lucide="file-down" class="w-4 h-4 mr-1"></i>
                            PDF
                        </a>
                        {% endif %}
                        <a href="/documents/{{ document.id }}" class="text-xs bg-emerald text-white px-3 py-1 rounded-md hover:bg-emerald/90 ml-2">詳細を見る</a>
                    {% endif %}
                {% else %}
                    {% if document.url %}
                        <a href="{{ document.url }}" target="_blank" rel="noopener noreferrer" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist">
                            <i data-lucide="external-link" class="w-4 h-4 mr-2"></i>
                            元記事
                        </a>
                        {% if document.pdf_path %}
                        <a href="/api/documents/{{ document.id }}/pdf" download title="PDFをダウンロード" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 transition-colors">
                            <i data-lucide="file-down" class="w-4 h-4 mr-1"></i>
                            PDF
                        </a>
                        {% endif %}
                        <a href="/documents/{{ document.id }}" class="text-xs bg-emerald text-white px-3 py-1 rounded-md hover:bg-emerald/90 ml-2">詳細を見る</a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </header>

    <section class="mt-3 w-full hidden" data-personalized-block aria-live="polite">
        <div class="flex flex-wrap items-center gap-2 text-xs font-semibold text-emerald-700">
            <i data-lucide="sparkles" class="w-4 h-4"></i>
            <span>あなたへのおすすめ</span>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-emerald/10 text-emerald-700 border border-emerald/20" data-personalized-rank></span>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white text-emerald-700 border border-emerald/40" data-personalized-score></span>
            <button
                type="button"
                class="ml-auto text-graphite hover:text-emerald-700 transition-colors cursor-pointer"
                style="background: none !important; border: none !important; padding: 0 !important; margin: 0 !important; outline: none !important;"
                data-personalized-toggle
                aria-expanded="false"
                aria-label="おすすめの詳細を表示">
                <i data-lucide="chevron-down" class="w-4 h-4" data-personalized-toggle-icon></i>
            </button>
        </div>
        <div class="hidden" data-personalized-details>
            <p class="mt-2 text-xs text-graphite leading-relaxed" data-personalized-explanation></p>
            <div class="mt-2 flex flex-wrap gap-2" data-personalized-components></div>
            <p class="mt-2 text-xs text-graphite/70" data-personalized-updated></p>
        </div>
    </section>

    <section class="mt-3 w-full hidden" data-personalized-fallback aria-live="polite">
        <div class="flex items-center gap-2 text-xs text-graphite">
            <i data-lucide="info" class="w-4 h-4"></i>
            <span data-personalized-fallback-text>記事をブックマークすると、あなた好みのおすすめ順で表示されます。</span>
        </div>
    </section>

    <div class="mt-4 pt-4 border-t border-dashed border-mist documents-divider-dashed flex-1">
        {% if document.short_summary %}
            <p class="mb-2">
                <span class="pill nowrap-tag mr-2 inline-flex items-center h-6 px-2 text-xs" style="background-color:#f5f3ff;color:#6b21a8;border-color:rgba(107,33,168,0.12)">要約</span>
            </p>
            <p class="text-sm text-graphite leading-relaxed break-words max-h-[7.5rem] overflow-auto" data-md-inline="{{ document.short_summary|e }}"></p>
            {% if not ns.autostart_done %}
                <span data-md-autostart="true" data-md="{{ document.short_summary|e }}" data-title="{{ document.title|e }}" class="hidden"></span>
                {% set ns.autostart_done = true %}
            {% endif %}
        {% else %}
            <p class="text-sm text-graphite leading-relaxed break-words max-h-[7.5rem] overflow-auto" data-md-inline="{{ (document.content_text[:300] ~ ('...' if document.content_text|length > 300 else ''))|e }}"></p>
        {% endif %}
    </div>

    <footer class="mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 w-full">
        <div class="tag-list flex items-center flex-wrap max-w-full">
            {% if document.classifications %}
                {% set cat = document.classifications[0].primary_category %}
                <span class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs {{ category_class_map.get(cat, 'bg-mist text-graphite') }}">
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    {{ cat }}
                </span>
                {% if document.classifications[0].tags %}
                    {% set all_tags = document.classifications[0].tags %}
                    {% set display_limit = 5 %}
                    {% for t in all_tags[:display_limit] %}
                        <a
                            href="/documents?tag={{ t }}"
                            class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs {% if selected_tag and selected_tag == t %}{{ '' }}{% else %}bg-mist/80 text-graphite border border-mist{% endif %}"
                            {% if selected_tag and selected_tag == t %}style="background-color:#fff1f2;color:#9f1239;border-color:#fecdd3"{% endif %}
                            hx-get="/documents"
                            hx-vals='{"tag": "{{ t }}"}'
                            hx-target="{{ container_target }}"
                            hx-push-url="true"
                            title="{{ t }}でフィルタ"
                        >
                            {{ t }}
                        </a>
                    {% endfor %}

                    {% if all_tags|length > display_limit %}
                        <button type="button" class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist tag-more-toggle" aria-expanded="false" title="残りのタグを表示">+{{ all_tags|length - display_limit }}</button>
                        <div class="tag-more-list hidden mt-2 tag-list flex flex-wrap">
                            {% for t in all_tags[display_limit:] %}
                                <a
                                    href="/documents?tag={{ t }}"
                                    class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-mist/80 text-graphite border border-mist"
                                    hx-get="/documents"
                                    hx-vals='{"tag": "{{ t }}"}'
                                    hx-target="{{ container_target }}"
                                    hx-push-url="true"
                                    title="{{ t }}でフィルタ"
                                >
                                    {{ t }}
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}
            {% endif %}
            <!-- 詳細を見るボタンはヘッダーの元記事の右側に移動しました -->
            <button
                class="bookmark-btn pill nowrap-tag inline-flex items-center h-6 px-2 text-xs ml-2 {% if not document.bookmarked %}bg-mist/80 text-graphite border border-mist{% endif %}"
                data-doc-id="{{ document.id }}"
                aria-pressed="{{ 'true' if document.bookmarked else 'false' }}"
                onclick="toggleBookmark(this)"
                title="ブックマーク"
                {% if document.bookmarked %}style="background-color:#fff1f2;color:#9f1239;border-color:#fecdd3"{% endif %}
            >
                <i data-lucide="heart" class="w-4 h-4 mr-2 {% if document.bookmarked %}text-rose-600{% else %}text-graphite{% endif %}" {% if document.bookmarked %}style="color: #9f1239;"{% endif %}></i>
                <span class="text-xs">ブックマーク</span>
            </button>
            <div
                class="flex items-center"
                data-personalized-feedback-container
                data-document-id="{{ document.id }}"
                data-feedback-state="pending"
            >
                <button
                    type="button"
                    class="pill nowrap-tag inline-flex items-center h-6 px-2 text-xs bg-white text-graphite border border-mist hover:bg-rose-50 hover:border-rose-200 transition-colors"
                    data-personalized-feedback-button
                    data-feedback-reason="low_relevance"
                    hx-post="/api/documents/{{ document.id }}/personalized-feedback"
                    hx-include="#personalized-feedback-session"
                    hx-vals='{"reason":"low_relevance"}'
                    hx-target="closest [data-personalized-feedback-container]"
                    hx-swap="outerHTML"
                    aria-label="関連性が低いとフィードバックする"
                >
                    <i data-lucide="thumbs-down" class="w-4 h-4 mr-2"></i>
                    <span>関連性が低い</span>
                </button>
            </div>
        </div>
        {% if document.bookmark_note %}
            <p class="text-xs text-graphite bg-mist/60 border border-mist rounded px-3 py-2 w-full sm:w-auto">
                <span class="font-semibold text-ink mr-1">メモ:</span>{{ document.bookmark_note }}
            </p>
        {% endif %}
    </footer>
</article>
