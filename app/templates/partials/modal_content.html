{% set ns = namespace(autostart_done=False) %}
<div class="relative bg-white rounded-lg w-full h-full md:max-w-4xl md:w-auto md:h-auto md:max-h-[85vh] md:mx-auto md:my-8 flex flex-col" data-modal-dialog>
  <!-- ヘッダー: タイトルと閉じるボタン -->
  <div class="flex items-start justify-between md:p-6 p-4 border-b flex-shrink-0">
    <div class="flex-1 min-w-0">
      {% include 'partials/_document_meta.html' %}
    </div>
    <button
      class="ml-4 text-gray-400 hover:text-gray-600 flex-shrink-0"
      aria-label="閉じる"
      data-modal-close
      type="button"
    >
      <i data-lucide="x" class="w-6 h-6"></i>
    </button>
  </div>

  <!-- コンテンツ: 本文、メタデータ -->
  <div class="md:p-6 p-4 overflow-y-auto flex-1 min-h-0 max-h-[60vh]" data-modal-scrollable style="overflow-y: auto; -webkit-overflow-scrolling: touch;">
    <!-- カテゴリとタグ -->
    {% if document.classifications %}
    <div class="tag-list flex items-center mb-6 flex-wrap">
      <span class="dify-tag-primary" title="{{ document.classifications[0].primary_category }}">
        <i data-lucide="tag" class="w-3 h-3"></i>
        {{ document.classifications[0].primary_category }}
      </span>

      {% if document.classifications[0].tags %}
        {% for tag in document.classifications[0].tags %}
          <span class="dify-tag-secondary" title="{{ tag }}">{{ tag }}</span>
        {% endfor %}
      {% endif %}
    </div>
    {% endif %}

    <!-- 要約 -->
    {% if document.short_summary %}
    <div class="mb-6">
      <p class="mb-2">
        <span class="pill nowrap-tag mr-2 inline-flex items-center h-6 px-2 text-xs" style="background-color:#f5f3ff;color:#6b21a8;border-color:rgba(107,33,168,0.12)">要約</span>
      </p>
      <p class="text-sm text-graphite leading-relaxed break-words max-h-[7.5rem] overflow-auto" data-md-inline="{{ document.short_summary | replace('"', '&quot;') }}"></p>
      {% if not ns.autostart_done %}
        <span data-md-autostart="true" data-md="{{ document.short_summary|e }}" data-title="{{ document.title|e }}" class="hidden"></span>
        {% set ns.autostart_done = true %}
      {% endif %}
    </div>
    {% endif %}

    <!-- 記事本文プレビュー (一覧と同様のデザイン: pill label + summary block) -->
    <div class="mb-6">
      <p class="mb-2">
        <span class="pill nowrap-tag mr-2 inline-flex items-center h-6 px-2 text-xs" style="background-color:#f5f3ff;color:#6b21a8;border-color:rgba(107,33,168,0.12)">コンテンツプレビュー</span>
      </p>
      <div class="prose max-w-none">
        {% set preview_content = document.content_md %}
        <div class="modal-content-wrap">
          <!-- 初期表示は高さ制限をつけて折りたたむ -->
          <p class="text-sm text-graphite leading-relaxed break-words modal-content-preview" data-md-inline="{{ (preview_content if preview_content else '') | e }}"></p>

          <!-- トグル: もっと見る / 折りたたむ -->
          <div class="mt-3">
            <button type="button" class="text-sm text-emerald hover:underline modal-readmore-toggle" aria-expanded="false">もっと見る</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 類似記事（HTMX lazy loading） -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-ink mb-2">関連ドキュメント</h2>
      <div
        hx-get="/api/documents/{{ document.id }}/similar"
        hx-trigger="load"
        hx-target="#modal-similar-documents"
        class="mt-2"
      >
        <div id="modal-similar-documents">
          <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- フッター: アクション -->
  <div class="flex items-center justify-between md:p-6 p-4 border-t flex-shrink-0">
    <div class="flex gap-3">
      <!-- ブックマークボタン -->
      {% set btn_context = "modal" %}
      {% set btn_document_id = document.id %}
      {% set btn_bookmarked = document.bookmarked %}
      {% include 'partials/bookmark_button.html' %}

      <!-- 元記事リンク -->
      {% if document.url %}
      <a href="{{ document.url }}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-4 py-2 bg-mist/80 text-graphite border border-mist rounded-md hover:bg-mist transition-colors modal-footer-link">
        <i data-lucide="external-link" class="w-5 h-5 mr-2"></i>
        元記事
      </a>
      {% endif %}

      <!-- Reader Mode -->
      <a href="/documents/{{ document.id }}/reader" class="inline-flex items-center px-4 py-2 bg-mist/80 text-graphite border border-mist rounded-md hover:bg-mist transition-colors">
        <i data-lucide="book-open" class="w-5 h-5 mr-2"></i>
        Reader Mode
      </a>
    </div>

  <button class="inline-flex items-center justify-center w-10 h-10 p-1 bg-emerald text-white rounded-full hover:bg-emerald/90 transition-colors modal-close-icon" data-modal-close type="button" aria-label="閉じる">
    <i data-lucide="x" class="w-4 h-4"></i>
  </button>
  </div>
</div>
