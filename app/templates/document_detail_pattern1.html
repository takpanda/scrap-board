{% extends "base.html" %}

{% block title %}{{ document.title }} - Scrap-Board{% endblock %}

{% block content %}
<!-- Pattern 1: Improved Traditional Layout with Sidebar -->
<div class="pattern1-container">
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="/documents" class="flex items-center space-x-2 text-graphite hover:text-ink transition-colors">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            <span>ドキュメント一覧に戻る</span>
        </a>
    </div>
    
    <div class="grid lg:grid-cols-4 gap-8">
        <!-- Sidebar - Document Info & Navigation -->
        <div class="lg:col-span-1">
            <div class="sidebar-sticky">
                <!-- Document Metadata Card -->
                <div class="sidebar-card">
                    <h3 class="sidebar-card-title">
                        <i data-lucide="info" class="w-4 h-4"></i>
                        文書情報
                    </h3>
                    
                    <div class="space-y-4">
                        {% if document.url %}
                        <div class="sidebar-item">
                            <div class="sidebar-item-label">
                                <i data-lucide="external-link" class="w-3 h-3"></i>
                                ソース
                            </div>
                            <a href="{{ document.url }}" target="_blank" class="sidebar-item-value hover:text-emerald transition-colors">
                                {{ document.domain }}
                            </a>
                        </div>
                        {% endif %}
                        
                        {% if document.author %}
                        <div class="sidebar-item">
                            <div class="sidebar-item-label">
                                <i data-lucide="user" class="w-3 h-3"></i>
                                著者
                            </div>
                            <div class="sidebar-item-value">{{ document.author }}</div>
                        </div>
                        {% endif %}
                        
                        {% if document.published_at %}
                        <div class="sidebar-item">
                            <div class="sidebar-item-label">
                                <i data-lucide="calendar" class="w-3 h-3"></i>
                                公開日
                            </div>
                            <div class="sidebar-item-value">{{ document.published_at.strftime('%Y年%m月%d日') }}</div>
                        </div>
                        {% endif %}
                        
                        <div class="sidebar-item">
                            <div class="sidebar-item-label">
                                <i data-lucide="clock" class="w-3 h-3"></i>
                                取得日
                            </div>
                            <div class="sidebar-item-value">{{ document.fetched_at.strftime('%Y年%m月%d日') }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Categories & Tags Card -->
                {% if document.classifications %}
                <div class="sidebar-card">
                    <h3 class="sidebar-card-title">
                        <i data-lucide="tag" class="w-4 h-4"></i>
                        分類とタグ
                    </h3>
                    
                    <div class="space-y-3">
                        <div>
                            <span class="tag-primary">
                                {{ document.classifications[0].primary_category }}
                            </span>
                        </div>
                        
                        {% if document.classifications[0].tags %}
                        <div class="flex flex-wrap gap-2">
                            {% for tag in document.classifications[0].tags %}
                            <span class="tag-secondary-sm">{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <div class="confidence-badge">
                            <i data-lucide="bar-chart-3" class="w-3 h-3"></i>
                            信頼度: {{ "%.0f" | format(document.classifications[0].confidence * 100) }}%
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Actions Card -->
                <div class="sidebar-card">
                    <h3 class="sidebar-card-title">
                        <i data-lucide="zap" class="w-4 h-4"></i>
                        アクション
                    </h3>
                    
                    <div class="space-y-3">
                        <a href="/reader/{{ document.id }}" 
                           class="sidebar-action-btn btn-primary">
                            <i data-lucide="book-open" class="w-4 h-4"></i>
                            Reader Mode
                        </a>
                        
                        {% if document.url %}
                        <a href="{{ document.url }}" target="_blank"
                           class="sidebar-action-btn btn-secondary">
                            <i data-lucide="external-link" class="w-4 h-4"></i>
                            元記事を開く
                        </a>
                        {% endif %}
                        
                        <button onclick="generateSummary()" class="sidebar-action-btn btn-outline">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                            要約を生成
                        </button>
                    </div>
                </div>
                
                <!-- Quick Navigation -->
                <div class="sidebar-card">
                    <h3 class="sidebar-card-title">
                        <i data-lucide="navigation" class="w-4 h-4"></i>
                        ページ内ナビ
                    </h3>
                    
                    <nav class="space-y-2">
                        <a href="#summary" class="sidebar-nav-link">
                            <i data-lucide="align-left" class="w-3 h-3"></i>
                            要約
                        </a>
                        <a href="#content" class="sidebar-nav-link">
                            <i data-lucide="file-text" class="w-3 h-3"></i>
                            本文
                        </a>
                        <a href="#related" class="sidebar-nav-link">
                            <i data-lucide="link" class="w-3 h-3"></i>
                            関連文書
                        </a>
                        <a href="#feedback" class="sidebar-nav-link">
                            <i data-lucide="message-circle" class="w-3 h-3"></i>
                            フィードバック
                        </a>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="lg:col-span-3">
            <!-- Document Title -->
            <div class="main-header">
                <h1 class="main-title">{{ document.title }}</h1>
                <div class="main-subtitle">
                    <span class="reading-time">推定読了時間: 5分</span>
                    <span class="word-count">約2,500文字</span>
                </div>
            </div>
            
            <!-- Summary Section -->
            <section id="summary" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i data-lucide="align-left" class="w-5 h-5"></i>
                        AI要約
                    </h2>
                    <button onclick="toggleSummaryType()" class="section-action-btn">
                        <i data-lucide="toggle-right" class="w-4 h-4"></i>
                        詳細要約に切り替え
                    </button>
                </div>
                
                <div id="summary-content" class="summary-content">
                    <div class="loading-skeleton">
                        <div class="skeleton-line w-3/4"></div>
                        <div class="skeleton-line w-1/2"></div>
                        <div class="skeleton-line w-2/3"></div>
                    </div>
                </div>
            </section>
            
            <!-- Content Section -->
            <section id="content" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i data-lucide="file-text" class="w-5 h-5"></i>
                        記事本文
                    </h2>
                    <button onclick="toggleFullContent()" class="section-action-btn" id="content-toggle">
                        <i data-lucide="expand" class="w-4 h-4"></i>
                        全文表示
                    </button>
                </div>
                
                <div class="content-body">
                    <div id="content-preview" class="prose max-w-none">
                        {{ document.content_md[:800] | markdown | safe }}{% if document.content_md|length > 800 %}<span class="text-gray-400">...</span>{% endif %}
                    </div>
                    <div id="content-full" class="hidden prose max-w-none">
                        {{ document.content_md | safe }}
                    </div>
                </div>
            </section>
            
            <!-- Related Documents Section -->
            <section id="related" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i data-lucide="link" class="w-5 h-5"></i>
                        関連ドキュメント
                    </h2>
                    <span class="section-subtitle">類似度スコアによる推奨文書</span>
                </div>
                
                <div id="related-content" 
                     hx-get="/api/documents/{{ document.id }}/similar"
                     hx-trigger="load"
                     hx-target="#related-content">
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- Loading skeleton -->
                        <div class="related-doc-card">
                            <div class="skeleton-line w-3/4 mb-2"></div>
                            <div class="skeleton-line w-1/2 mb-1"></div>
                            <div class="skeleton-line w-1/3"></div>
                        </div>
                        <div class="related-doc-card">
                            <div class="skeleton-line w-2/3 mb-2"></div>
                            <div class="skeleton-line w-1/3 mb-1"></div>
                            <div class="skeleton-line w-1/4"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Feedback Section (Full Width) -->
    <section id="feedback" class="feedback-section">
        <div class="feedback-container">
            <div class="feedback-header">
                <h3 class="feedback-title">この分類は正確ですか？</h3>
                <p class="feedback-subtitle">あなたのフィードバックは分類精度の向上に活用されます</p>
            </div>
            
            <div class="feedback-actions">
                <button onclick="submitFeedback('correct')" class="feedback-btn feedback-btn-positive">
                    <i data-lucide="thumbs-up" class="w-5 h-5"></i>
                    <span>正確</span>
                </button>
                
                <button onclick="submitFeedback('incorrect')" class="feedback-btn feedback-btn-negative">
                    <i data-lucide="thumbs-down" class="w-5 h-5"></i>
                    <span>修正が必要</span>
                </button>
                
                <button onclick="openFeedbackForm()" class="feedback-btn feedback-btn-neutral">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                    <span>詳細フィードバック</span>
                </button>
            </div>
        </div>
    </section>
</div>
</div>

<script>
    let summaryLoaded = false;
    let fullContentVisible = false;
    let showingDetailedSummary = false;
    
    // Auto-load summary on page load
    function autoLoadSummary() {
        const content = document.getElementById('summary-content');
        
        if (!summaryLoaded) {
            fetch(`/api/documents/{{ document.id }}/summarize`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                content.innerHTML = `
                    <div class="summary-box">
                        <div class="summary-text">${markdownToHtml(data.short_summary || '要約の生成に失敗しました。')}</div>
                    </div>
                `;
                summaryLoaded = true;
            })
            .catch(error => {
                content.innerHTML = `
                    <div class="error-box">
                        <p>要約の生成中にエラーが発生しました。</p>
                    </div>
                `;
            });
        }
    }
    
    function toggleSummaryType() {
        // Toggle between short and detailed summary
        showingDetailedSummary = !showingDetailedSummary;
        const btn = event.target;
        const icon = btn.querySelector('i');
        const text = btn.querySelector('span') || btn;
        
        if (showingDetailedSummary) {
            text.textContent = '短要約に戻る';
            icon.setAttribute('data-lucide', 'toggle-left');
        } else {
            text.textContent = '詳細要約に切り替え';
            icon.setAttribute('data-lucide', 'toggle-right');
        }
        
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }
    
    function toggleFullContent() {
        const preview = document.getElementById('content-preview');
        const full = document.getElementById('content-full');
        const toggle = document.getElementById('content-toggle');
        const icon = toggle.querySelector('i');
        const text = toggle.querySelector('span') || toggle;
        
        if (fullContentVisible) {
            preview.classList.remove('hidden');
            full.classList.add('hidden');
            text.textContent = '全文表示';
            icon.setAttribute('data-lucide', 'expand');
            fullContentVisible = false;
        } else {
            preview.classList.add('hidden');
            full.classList.remove('hidden');
            text.textContent = '概要に戻る';
            icon.setAttribute('data-lucide', 'minimize');
            fullContentVisible = true;
        }
        
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }
    
    function generateSummary() {
        autoLoadSummary();
    }
    
    function submitFeedback(label) {
        fetch(`/api/documents/{{ document.id }}/feedback`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ label: label })
        })
        .then(response => response.json())
        .then(data => {
            alert(label === 'correct' ? 'フィードバックありがとうございます！' : '修正のご指摘ありがとうございます。今後の改善に活用させていただきます。');
        })
        .catch(error => {
            alert('フィードバックの送信に失敗しました。');
        });
    }
    
    function openFeedbackForm() {
        // Open detailed feedback modal
        alert('詳細フィードバック機能は近日公開予定です。');
    }
    
    // Simple Markdown to HTML converter
    function markdownToHtml(text) {
        if (!text) return '';
        
        return text
            .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
            .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>')
            .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-4 mb-2">$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
            .replace(/__(.*?)__/g, '<strong class="font-semibold">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
            .replace(/_(.*?)_/g, '<em class="italic">$1</em>')
            .replace(/```(.*?)```/gs, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">$1</code>')
            .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm font-mono">$1</code>')
            .replace(/^[\-\*] (.*$)/gim, '<li class="ml-4">• $1</li>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
    }
    
    // Smooth scrolling for navigation links
    document.querySelectorAll('.sidebar-nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        autoLoadSummary();
    });
</script>
{% endblock %}