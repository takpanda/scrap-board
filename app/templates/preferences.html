{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 px-4">
  <!-- ヘッダー -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-ink mb-2">ブックマーク嗜好分析</h1>
    <p class="text-graphite">あなたのブックマーク傾向を可視化します</p>
  </div>

  <!-- サマリーカード -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4 border border-mist">
      <div class="text-sm text-graphite mb-1">ブックマーク総数</div>
      <div class="text-2xl font-bold text-ink">{{ analysis.summary.total_bookmarks }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border border-mist">
      <div class="text-sm text-graphite mb-1">カテゴリ数</div>
      <div class="text-2xl font-bold text-emerald">{{ analysis.summary.categories_count }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border border-mist">
      <div class="text-sm text-graphite mb-1">ドメイン数</div>
      <div class="text-2xl font-bold text-indigo-600">{{ analysis.summary.unique_domains }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4 border border-mist">
      <div class="text-sm text-graphite mb-1">プロファイル状態</div>
      <div class="text-sm font-semibold">
        {% if analysis.summary.profile_status == 'active' %}
          <span class="text-emerald">✓ アクティブ</span>
        {% elif analysis.summary.profile_status == 'cold_start' %}
          <span class="text-amber-600">⋯ 初期状態</span>
        {% elif analysis.summary.profile_status == 'error' %}
          <span class="text-red-600">✗ エラー</span>
        {% else %}
          <span class="text-graphite">不明</span>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- 頻出トピック -->
    <div class="bg-white rounded-lg shadow p-6 border border-mist">
      <h2 class="text-xl font-bold text-ink mb-4">頻出トピック</h2>
      {% if analysis.top_topics %}
        <div class="space-y-3">
          {% for topic in analysis.top_topics %}
            <div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium text-graphite">{{ topic.name }}</span>
                <span class="text-sm text-graphite">{{ topic.count }}件 ({{ topic.percentage }}%)</span>
              </div>
              <div class="w-full bg-mist rounded-full h-2">
                <div class="bg-emerald h-2 rounded-full" style="width: {{ topic.percentage }}%"></div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-graphite text-sm">データがありません</p>
      {% endif %}
    </div>

    <!-- 主要キーワード -->
    <div class="bg-white rounded-lg shadow p-6 border border-mist">
      <h2 class="text-xl font-bold text-ink mb-4">主要キーワード</h2>
      {% if analysis.top_keywords %}
        <div class="flex flex-wrap gap-2">
          {% for kw in analysis.top_keywords %}
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-emerald-50 text-emerald-800 border border-emerald-200">
              {{ kw.keyword }}
              <span class="ml-1 text-xs text-emerald-600">{{ kw.count }}</span>
            </span>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-graphite text-sm">データがありません</p>
      {% endif %}
    </div>
  </div>

  <!-- 上位記事リスト -->
  <div class="bg-white rounded-lg shadow p-6 border border-mist mb-6">
    <h2 class="text-xl font-bold text-ink mb-4">上位記事</h2>
    {% if analysis.top_articles %}
      <div class="space-y-4">
        {% for article in analysis.top_articles %}
          <div class="border-b border-mist pb-4 last:border-b-0">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-medium text-ink hover:text-emerald">
                  {% if article.url %}
                    <a href="/documents/{{ article.id }}" class="hover:underline">{{ article.title }}</a>
                  {% else %}
                    {{ article.title }}
                  {% endif %}
                </h3>
                <div class="flex items-center gap-3 mt-2 text-sm text-graphite">
                  {% if article.domain %}
                    <span class="flex items-center">
                      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                      </svg>
                      {{ article.domain }}
                    </span>
                  {% endif %}
                  {% if article.category %}
                    <span class="px-2 py-0.5 rounded bg-emerald-100 text-emerald-800 text-xs">{{ article.category }}</span>
                  {% endif %}
                  {% if article.bookmarked_at %}
                    <span>{{ article.bookmarked_at[:10] }}</span>
                  {% endif %}
                </div>
                {% if article.summary %}
                  <p class="mt-2 text-sm text-graphite line-clamp-2">{{ article.summary }}</p>
                {% endif %}
                {% if article.tags %}
                  <div class="flex flex-wrap gap-1 mt-2">
                    {% for tag in article.tags[:5] %}
                      <span class="text-xs px-2 py-0.5 rounded bg-mist text-graphite">{{ tag }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-graphite text-sm">データがありません</p>
    {% endif %}
  </div>

  <!-- 最近のブックマーク履歴 -->
  <div class="bg-white rounded-lg shadow p-6 border border-mist">
    <h2 class="text-xl font-bold text-ink mb-4">最近のブックマーク</h2>
    {% if analysis.recent_bookmarks %}
      <div class="space-y-2">
        {% for item in analysis.recent_bookmarks %}
          <div class="flex items-center justify-between py-2 border-b border-mist last:border-b-0">
            <div class="flex-1">
              <a href="/documents/{{ item.id }}" class="text-sm font-medium text-ink hover:text-emerald hover:underline">
                {{ item.title }}
              </a>
              {% if item.category %}
                <span class="ml-2 text-xs px-2 py-0.5 rounded bg-emerald-100 text-emerald-800">{{ item.category }}</span>
              {% endif %}
            </div>
            {% if item.bookmarked_at %}
              <span class="text-xs text-graphite ml-4">{{ item.bookmarked_at[:10] }}</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-graphite text-sm">データがありません</p>
    {% endif %}
  </div>

  <!-- プロファイル重み情報 (デバッグ用、必要に応じて非表示) -->
  {% if analysis.profile_weights.categories or analysis.profile_weights.domains %}
  <div class="bg-white rounded-lg shadow p-6 border border-mist mt-6">
    <h2 class="text-xl font-bold text-ink mb-4">プロファイル重み</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {% if analysis.profile_weights.categories %}
      <div>
        <h3 class="text-sm font-semibold text-graphite mb-2">カテゴリ重み</h3>
        <div class="space-y-1">
          {% for category, weight in analysis.profile_weights.categories.items() %}
            <div class="flex justify-between text-sm">
              <span class="text-graphite">{{ category }}</span>
              <span class="font-mono text-ink">{{ "%.3f"|format(weight) }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      {% if analysis.profile_weights.domains %}
      <div>
        <h3 class="text-sm font-semibold text-graphite mb-2">ドメイン重み</h3>
        <div class="space-y-1">
          {% for domain, weight in analysis.profile_weights.domains.items() %}
            <div class="flex justify-between text-sm">
              <span class="text-graphite">{{ domain }}</span>
              <span class="font-mono text-ink">{{ "%.3f"|format(weight) }}</span>
            </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Chart.js を使用したグラフ描画のためのスクリプト -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // トピック円グラフの描画（必要に応じて有効化）
  // const topicsData = {{ analysis.top_topics | tojson }};
  // if (topicsData && topicsData.length > 0) {
  //   // グラフ描画コード
  // }
</script>
{% endblock %}
