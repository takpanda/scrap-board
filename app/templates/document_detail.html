{% extends "base.html" %}

{% block title %}{{ document.title }} - Scrap-Board{% endblock %}

{% block content %}
<div class="document-container overflow-x-auto md:overflow-x-visible">
    <div class="max-w-6xl mx-auto px-6 py-8">
        <div id="doc-data" data-has-short-summary="{{ '1' if document.short_summary else '0' }}" style="display:none"></div>

        <a href="/documents" class="dify-back-btn">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            <span>ドキュメント一覧に戻る</span>
        </a>

        <div class="dify-header-card card-edge">
            {% include 'partials/_document_meta.html' %}

            {% if document.classifications %}
            <div class="flex items-start mb-6 md:overflow-x-auto md:whitespace-nowrap flex-wrap md:flex-nowrap" style="gap: 0.5rem; align-items:center;">
                <span class="dify-tag-primary">
                    <i data-lucide="tag" class="w-3 h-3"></i>
                    {{ document.classifications[0].primary_category }}
                </span>

                {% if document.classifications[0].tags %}
                    {% for tag in document.classifications[0].tags %}
                        <span class="dify-tag-secondary">{{ tag }}</span>
                    {% endfor %}
                {% endif %}

                <!-- Bookmark button inline with tags (icon-only) -->
                <button
                    class="ml-2 p-1 rounded hover:bg-gray-100"
                    aria-pressed="{{ 'true' if document.bookmarked else 'false' }}"
                    onclick="toggleBookmarkDetail(this)"
                    data-doc-id="{{ document.id }}"
                    title="ブックマーク"
                >
                    <i data-lucide="heart" class="w-5 h-5 {% if document.bookmarked %}text-rose-600{% else %}text-graphite{% endif %}" {% if document.bookmarked %}style="color: #9f1239;"{% endif %}></i>
                </button>
            </div>
            {% endif %}
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2">
                <div class="dify-content-card card-edge">
                    <div class="dify-content-header">
                        <h2 class="dify-section-title">
                            <i data-lucide="file-text" class="w-5 h-5"></i>
                            コンテンツプレビュー
                        </h2>
                        <button
                            onclick="toggleFullContent()"
                            id="content-toggle"
                            class="dify-toggle-btn"
                        >
                            <span>全文を表示</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div id="content-preview" class="prose max-w-none break-words">
                        <div class="dify-content-text">
                            {{ document.content_md[:500] | markdown | safe }}{% if document.content_md|length > 500 %}<span class="text-gray-400">...</span>{% endif %}
                        </div>
                    </div>

                    <div id="content-full" class="hidden prose max-w-none break-words">
                        <div class="dify-content-text">
                            {{ document.content_md | safe }}
                        </div>
                    </div>
                </div>

                <div class="dify-content-card card-edge mt-6">
                    <h2 class="dify-section-title">関連ドキュメント</h2>
                    <div
                        hx-get="/api/documents/{{ document.id }}/similar"
                        hx-trigger="load"
                        hx-target="#similar-documents"
                        class="mt-4"
                    >
                        <div id="similar-documents" class="dify-similar-list">
                            <!-- Loading placeholders -->
                            <div class="dify-similar-card animate-pulse">
                                <div class="dify-loading-line w-3/4 mb-2"></div>
                                <div class="dify-loading-line w-1/2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <aside>
                <div class="dify-content-card card-edge">
                    <h3 class="dify-section-title">要約</h3>
                    <div id="summary-section">
                        {% if document.short_summary %}
                            <div class="dify-summary-container">
                                <div class="dify-summary-badge"><span>保存済み要約</span></div>
                                <div class="dify-summary-content">{{ document.short_summary | safe }}</div>
                            </div>
                        {% else %}
                            <div id="summary-content">
                                <p class="text-gray-500">要約を生成しています...</p>
                            </div>
                        {% endif %}
                    </div>

                    <div class="mt-4">
                        <button id="content-view-toggle" onclick="toggleContentView()" class="dify-toggle-btn">
                            <span>全文を表示</span>
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </aside>
        </div>

        <script>
            let summaryLoaded = false;
            let fullContentVisible = false;
            let showingSummary = true;

            function markdownToHtml(text) {
                if (!text) return '';
                return text
                    .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-4 mb-2">$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
                    .replace(/__(.*?)__/g, '<strong class="font-semibold">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                    .replace(/_(.*?)_/g, '<em class="italic">$1</em>')
                    .replace(/```(.*?)```/gs, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">$1</code>')
                    .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm font-mono">$1</code>')
                    .replace(/^[\-\*] (.*$)/gim, '<li class="ml-4">• $1</li>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
            }

            function autoLoadSummary() {
                const content = document.getElementById('summary-content');
                if (!content || summaryLoaded) return;

                fetch(`/api/documents/{{ document.id }}/summarize`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        const summaryHtml = markdownToHtml(data.short_summary || '要約の生成に失敗しました。');
                        content.innerHTML = `<div class="dify-summary-container"><div class="dify-summary-badge"><span>AI生成要約</span></div><div class="dify-summary-content">${summaryHtml}</div></div>`;
                        summaryLoaded = true;
                        if (window.lucide) window.lucide.createIcons();
                    })
                    .catch(() => {
                        content.innerHTML = `<div class="dify-error-container"><p class="dify-error-text">要約の生成中にエラーが発生しました。</p></div>`;
                    });
            }

            function toggleContentView() {
                const summarySection = document.getElementById('summary-section');
                const contentSection = document.getElementById('content-preview');
                const toggleButton = document.getElementById('content-view-toggle') || document.getElementById('content-toggle');
                const toggleIcon = toggleButton ? toggleButton.querySelector('i') : null;
                const toggleText = toggleButton ? toggleButton.querySelector('span') : null;

                if (showingSummary) {
                    if (summarySection) summarySection.classList.add('hidden');
                    if (contentSection) contentSection.classList.remove('hidden');
                    if (toggleText) toggleText.textContent = '要約に戻る';
                    if (toggleIcon) toggleIcon.setAttribute('data-lucide', 'arrow-left');
                    showingSummary = false;
                } else {
                    if (summarySection) summarySection.classList.remove('hidden');
                    if (contentSection) contentSection.classList.add('hidden');
                    if (toggleText) toggleText.textContent = '全文を表示';
                    if (toggleIcon) toggleIcon.setAttribute('data-lucide', 'file-text');
                    showingSummary = true;
                }

                if (window.lucide) window.lucide.createIcons();
            }

            function toggleFullContent() {
                const preview = document.getElementById('content-preview');
                const full = document.getElementById('content-full');
                const toggle = document.getElementById('content-toggle');
                const toggleText = toggle ? toggle.querySelector('span') : null;

                if (!preview || !full) return;

                if (fullContentVisible) {
                    preview.classList.remove('hidden');
                    full.classList.add('hidden');
                    if (toggleText) toggleText.textContent = '全文を表示';
                    fullContentVisible = false;
                } else {
                    preview.classList.add('hidden');
                    full.classList.remove('hidden');
                    if (toggleText) toggleText.textContent = '概要に戻る';
                    fullContentVisible = true;
                }
            }

            function toggleBookmarkDetail(btn) {
                const docId = btn && btn.dataset && btn.dataset.docId;
                if (!docId) return;
                const pressed = btn.getAttribute('aria-pressed') === 'true';
                const method = pressed ? 'DELETE' : 'POST';

                if (!pressed) {
                    fetch('/api/bookmarks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ document_id: docId })
                    }).then(resp => {
                        if (resp.ok) {
                            btn.setAttribute('aria-pressed', 'true');
                            if (window.lucide) window.lucide.createIcons();
                            if (typeof showNotification === 'function') showNotification('ブックマークしました', 'success');
                        }
                    }).catch(() => {});
                } else {
                    fetch(`/api/bookmarks?document_id=${encodeURIComponent(docId)}`, { method: 'DELETE' })
                        .then(resp => {
                            if (resp.ok) {
                                btn.setAttribute('aria-pressed', 'false');
                                if (window.lucide) window.lucide.createIcons();
                                if (typeof showNotification === 'function') showNotification('ブックマークを解除しました', 'success');
                            }
                        }).catch(() => {});
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                if (window.lucide) window.lucide.createIcons();
                const docData = document.getElementById('doc-data');
                const hasShortSummary = docData && docData.dataset.hasShortSummary === '1';
                if (!hasShortSummary) autoLoadSummary();
            });
        </script>
    </div>
</div>

{% endblock %}

                    // Italic text (*italic* や _italic_)
                    .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                    .replace(/_(.*?)_/g, '<em class="italic">$1</em>')

                    // Code blocks (```code```)
                    .replace(/```(.*?)```/gs, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">$1</code>')

                    // Inline code (`code`)
                    .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm font-mono">$1</code>')

                    // Lists (- item や * item)
                    .replace(/^[\-\*] (.*$)/gim, '<li class="ml-4">• $1</li>')

                    // Line breaks (double newlines become <br>)
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
            }

            // Auto-load summary on page load
            function autoLoadSummary() {
                const content = document.getElementById('summary-content');

                if (!summaryLoaded) {
                    // Load summary via AI
                    fetch(`/api/documents/{{ document.id }}/summarize`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const summaryHtml = markdownToHtml(data.short_summary || '要約の生成に失敗しました。');
                        content.innerHTML = `
                            <div class="dify-summary-container">
                                <div class="dify-summary-badge">
                                    <span>AI生成要約</span>
                                </div>
                                <div class="dify-summary-content">${summaryHtml}</div>
                            </div>
                        `;
                        summaryLoaded = true;
                    })
                    .catch(error => {
                        content.innerHTML = `
                            <div class="dify-error-container">
                                <div class="dify-error-icon">
                                    <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                </div>
                                <p class="dify-error-text">要約の生成中にエラーが発生しました。</p>
                            </div>
                        `;
                    });
                }
            }

            // Toggle between summary view and full content view
            function toggleContentView() {
                const summarySection = document.getElementById('summary-section');
                const contentSection = document.getElementById('content-section');
                const toggleButton = document.getElementById('content-view-toggle');
                const toggleIcon = toggleButton.querySelector('i');
                const toggleText = toggleButton.querySelector('span');

                if (showingSummary) {
                    // Switch to full content view
                    summarySection.classList.add('hidden');
                    contentSection.classList.remove('hidden');
                    toggleText.textContent = '要約に戻る';
                    toggleIcon.setAttribute('data-lucide', 'arrow-left');
                    showingSummary = false;
                } else {
                    // Switch to summary view
                    summarySection.classList.remove('hidden');
                    contentSection.classList.add('hidden');
                    toggleText.textContent = '全文を表示';
                    toggleIcon.setAttribute('data-lucide', 'file-text');
                    showingSummary = true;
                }

                // Re-initialize lucide icons after changing them
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }

            function toggleFullContent() {
                const preview = document.getElementById('content-preview');
                const full = document.getElementById('content-full');
                const toggle = document.getElementById('content-toggle');
                const toggleText = toggle.querySelector('span');

                if (fullContentVisible) {
                    preview.classList.remove('hidden');
                    full.classList.add('hidden');
                    toggleText.textContent = '全文を表示';
                    fullContentVisible = false;
                } else {
                    preview.classList.add('hidden');
                    full.classList.remove('hidden');
                    toggleText.textContent = '概要に戻る';
                    fullContentVisible = true;
                }
            }

            // Initialize icons and auto-load summary
            document.addEventListener('DOMContentLoaded', function() {
                if (window.lucide) {
                    lucide.createIcons();
                }
                // Auto-load summary only when no saved short_summary exists
                const docData = document.getElementById('doc-data');
                const hasShortSummary = docData && docData.dataset.hasShortSummary === '1';
                if (!hasShortSummary) {
                    autoLoadSummary(); // Auto-load summary on page load
                }
            });
        </script>
        {% endblock %}
                            .then(data => {
                                const summaryHtml = markdownToHtml(data.short_summary || '要約の生成に失敗しました。');
                                content.innerHTML = `
                                    <div class="dify-summary-container">
                                        <div class="dify-summary-badge">
                                            <span>AI生成要約</span>
                                        </div>
                                        <div class="dify-summary-content">${summaryHtml}</div>
                                    </div>
                                `;
                                summaryLoaded = true;
                            })
                            .catch(error => {
                                content.innerHTML = `
                                    <div class="dify-error-container">
                                        <div class="dify-error-icon">
                                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                                        </div>
                                        <p class="dify-error-text">要約の生成中にエラーが発生しました。</p>
                                    </div>
                                `;
                            });
                        }
                    }
    
                    // Toggle between summary view and full content view
                    function toggleContentView() {
                        const summarySection = document.getElementById('summary-section');
                        const contentSection = document.getElementById('content-section');
                        const toggleButton = document.getElementById('content-view-toggle');
                        const toggleIcon = toggleButton.querySelector('i');
                        const toggleText = toggleButton.querySelector('span');
        
                        if (showingSummary) {
                            // Switch to full content view
                            summarySection.classList.add('hidden');
                            contentSection.classList.remove('hidden');
                            toggleText.textContent = '要約に戻る';
                            toggleIcon.setAttribute('data-lucide', 'arrow-left');
                            showingSummary = false;
                        } else {
                            // Switch to summary view
                            summarySection.classList.remove('hidden');
                            contentSection.classList.add('hidden');
                            toggleText.textContent = '全文を表示';
                            toggleIcon.setAttribute('data-lucide', 'file-text');
                            showingSummary = true;
                        }
        
                        // Re-initialize lucide icons after changing them
                        if (window.lucide) {
                            window.lucide.createIcons();
                        }
                    }
    
                    function toggleFullContent() {
                        const preview = document.getElementById('content-preview');
                        const full = document.getElementById('content-full');
                        const toggle = document.getElementById('content-toggle');
                        const toggleText = toggle.querySelector('span');
        
                        if (fullContentVisible) {
                            preview.classList.remove('hidden');
                            full.classList.add('hidden');
                            toggleText.textContent = '全文を表示';
                            fullContentVisible = false;
                        } else {
                            preview.classList.add('hidden');
                            full.classList.remove('hidden');
                            toggleText.textContent = '概要に戻る';
                            fullContentVisible = true;
                        }
                    }
    
                    // Initialize icons and auto-load summary
                    document.addEventListener('DOMContentLoaded', function() {
                        if (window.lucide) {
                            lucide.createIcons();
                        }
                        // Auto-load summary only when no saved short_summary exists
                        const docData = document.getElementById('doc-data');
                        const hasShortSummary = docData && docData.dataset.hasShortSummary === '1';
                        if (!hasShortSummary) {
                            autoLoadSummary(); // Auto-load summary on page load
                        }
                    });
                </script>
                {% endblock %}