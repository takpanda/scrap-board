{% extends "base.html" %}

{% block title %}{{ document.title }} - Scrap-Board{% endblock %}

{% block content %}
<!-- Pattern 2: Split Layout (Two Column Design) -->
<div class="pattern2-container">
<div class="split-layout">
    <!-- Left Panel - Metadata & Navigation -->
    <div class="split-left">
        <div class="left-panel-content">
            <!-- Back Navigation -->
            <div class="back-nav">
                <a href="/documents" class="back-link">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    <span>戻る</span>
                </a>
            </div>
            
            <!-- Document Header -->
            <div class="doc-header">
                <h1 class="doc-title">{{ document.title }}</h1>
                
                <!-- Source Info -->
                <div class="source-info">
                    {% if document.url %}
                    <a href="{{ document.url }}" target="_blank" class="source-link">
                        <i data-lucide="external-link" class="w-4 h-4"></i>
                        <span>{{ document.domain }}</span>
                    </a>
                    {% else %}
                    <div class="source-link">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        <span>PDF ファイル</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Meta Information Grid -->
            <div class="meta-grid">
                {% if document.author %}
                <div class="meta-item">
                    <div class="meta-label">
                        <i data-lucide="user" class="w-4 h-4"></i>
                        著者
                    </div>
                    <div class="meta-value">{{ document.author }}</div>
                </div>
                {% endif %}
                
                {% if document.published_at %}
                <div class="meta-item">
                    <div class="meta-label">
                        <i data-lucide="calendar" class="w-4 h-4"></i>
                        公開日
                    </div>
                    <div class="meta-value">{{ document.published_at.strftime('%Y/%m/%d') }}</div>
                </div>
                {% endif %}
                
                <div class="meta-item">
                    <div class="meta-label">
                        <i data-lucide="clock" class="w-4 h-4"></i>
                        取得日
                    </div>
                    <div class="meta-value">{{ document.fetched_at.strftime('%Y/%m/%d') }}</div>
                </div>
                
                <div class="meta-item">
                    <div class="meta-label">
                        <i data-lucide="file-text" class="w-4 h-4"></i>
                        文字数
                    </div>
                    <div class="meta-value">約 {{ document.content_text|length }} 文字</div>
                </div>
            </div>
            
            <!-- Classification -->
            {% if document.classifications %}
            <div class="classification-panel">
                <h3 class="panel-title">
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    分類情報
                </h3>
                
                <div class="classification-content">
                    <div class="primary-category">
                        <span class="category-badge">
                            {{ document.classifications[0].primary_category }}
                        </span>
                        <div class="confidence-meter">
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: {{ document.classifications[0].confidence * 100 }}%"></div>
                            </div>
                            <span class="confidence-text">{{ "%.0f" | format(document.classifications[0].confidence * 100) }}%</span>
                        </div>
                    </div>
                    
                    {% if document.classifications[0].tags %}
                    <div class="tags-section">
                        <div class="tags-label">関連タグ</div>
                        <div class="tags-list">
                            {% for tag in document.classifications[0].tags %}
                            <span class="tag-chip">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Action Panel -->
            <div class="action-panel">
                <h3 class="panel-title">
                    <i data-lucide="zap" class="w-4 h-4"></i>
                    アクション
                </h3>
                
                <div class="action-buttons">
                    <a href="/reader/{{ document.id }}" class="action-btn primary">
                        <i data-lucide="book-open" class="w-5 h-5"></i>
                        <div class="btn-content">
                            <span class="btn-title">Reader Mode</span>
                            <span class="btn-subtitle">最適化された読書体験</span>
                        </div>
                    </a>
                    
                    {% if document.url %}
                    <a href="{{ document.url }}" target="_blank" class="action-btn secondary">
                        <i data-lucide="external-link" class="w-5 h-5"></i>
                        <div class="btn-content">
                            <span class="btn-title">元記事</span>
                            <span class="btn-subtitle">オリジナルサイトで開く</span>
                        </div>
                    </a>
                    {% endif %}
                    
                    <button onclick="exportDocument()" class="action-btn tertiary">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        <div class="btn-content">
                            <span class="btn-title">エクスポート</span>
                            <span class="btn-subtitle">PDF・Markdown出力</span>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Related Documents Preview -->
            <div class="related-preview">
                <h3 class="panel-title">
                    <i data-lucide="link" class="w-4 h-4"></i>
                    関連文書
                </h3>
                
                <div id="related-sidebar" 
                     hx-get="/api/documents/{{ document.id }}/similar?limit=3"
                     hx-trigger="load"
                     hx-target="#related-sidebar">
                    <!-- Loading state -->
                    <div class="related-loading">
                        <div class="related-item-skeleton">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-meta"></div>
                        </div>
                        <div class="related-item-skeleton">
                            <div class="skeleton-title"></div>
                            <div class="skeleton-meta"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Right Panel - Main Content -->
    <div class="split-right">
        <div class="content-tabs">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="summary">
                    <i data-lucide="align-left" class="w-4 h-4"></i>
                    要約
                </button>
                <button class="tab-btn" data-tab="content">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    本文
                </button>
                <button class="tab-btn" data-tab="analysis">
                    <i data-lucide="pie-chart" class="w-4 h-4"></i>
                    分析
                </button>
            </div>
            
            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Summary Tab -->
                <div class="tab-panel active" id="summary-tab">
                    <div class="content-header">
                        <h2 class="content-title">AI生成要約</h2>
                        <div class="content-controls">
                            <button onclick="regenerateSummary()" class="control-btn">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                再生成
                            </button>
                            <button onclick="toggleSummaryLength()" class="control-btn" id="summary-length-toggle">
                                <i data-lucide="maximize-2" class="w-4 h-4"></i>
                                詳細版
                            </button>
                        </div>
                    </div>
                    
                    <div class="summary-container">
                        <div id="summary-content" class="summary-content">
                            <div class="summary-loading">
                                <div class="loading-spinner"></div>
                                <p>要約を生成中...</p>
                            </div>
                        </div>
                        
                        <div class="summary-stats">
                            <div class="stat-item">
                                <span class="stat-label">要約率</span>
                                <span class="stat-value" id="summary-ratio">--%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">キーワード</span>
                                <span class="stat-value" id="keyword-count">--個</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Content Tab -->
                <div class="tab-panel" id="content-tab">
                    <div class="content-header">
                        <h2 class="content-title">記事本文</h2>
                        <div class="content-controls">
                            <button onclick="toggleReadingMode()" class="control-btn">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                読書モード
                            </button>
                            <button onclick="copyContent()" class="control-btn">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                                コピー
                            </button>
                        </div>
                    </div>
                    
                    <div class="article-content">
                        <div id="content-preview" class="content-body">
                            <div class="content-preview-box">
                                {{ document.content_md[:1000] | markdown | safe }}
                                {% if document.content_md|length > 1000 %}
                                <div class="content-fade"></div>
                                <button onclick="showFullContent()" class="show-more-btn">
                                    <span>続きを読む</span>
                                    <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div id="content-full" class="content-body hidden">
                            <div class="prose prose-lg max-w-none">
                                {{ document.content_md | safe }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analysis Tab -->
                <div class="tab-panel" id="analysis-tab">
                    <div class="content-header">
                        <h2 class="content-title">文書分析</h2>
                        <div class="content-controls">
                            <button onclick="updateAnalysis()" class="control-btn">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                更新
                            </button>
                        </div>
                    </div>
                    
                    <div class="analysis-content">
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <h4 class="analysis-card-title">
                                    <i data-lucide="trending-up" class="w-4 h-4"></i>
                                    読了時間
                                </h4>
                                <div class="analysis-card-value">約 5分</div>
                                <div class="analysis-card-detail">平均読書速度に基づく</div>
                            </div>
                            
                            <div class="analysis-card">
                                <h4 class="analysis-card-title">
                                    <i data-lucide="layers" class="w-4 h-4"></i>
                                    複雑度
                                </h4>
                                <div class="analysis-card-value">中級</div>
                                <div class="analysis-card-detail">専門知識が一部必要</div>
                            </div>
                            
                            <div class="analysis-card">
                                <h4 class="analysis-card-title">
                                    <i data-lucide="hash" class="w-4 h-4"></i>
                                    キーワード密度
                                </h4>
                                <div class="analysis-card-value">良好</div>
                                <div class="analysis-card-detail">適切なバランス</div>
                            </div>
                        </div>
                        
                        <div class="keyword-analysis">
                            <h4 class="analysis-section-title">主要キーワード</h4>
                            <div class="keyword-cloud">
                                <span class="keyword-tag high">AI</span>
                                <span class="keyword-tag medium">機械学習</span>
                                <span class="keyword-tag medium">技術</span>
                                <span class="keyword-tag low">システム</span>
                                <span class="keyword-tag low">データ</span>
                                <span class="keyword-tag low">開発</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Feedback Panel -->
<div class="floating-feedback">
    <button onclick="toggleFeedbackPanel()" class="feedback-toggle">
        <i data-lucide="message-circle" class="w-5 h-5"></i>
        <span>フィードバック</span>
    </button>
    
    <div class="feedback-panel hidden" id="feedback-panel">
        <div class="feedback-header">
            <h3>この文書の分類は正確ですか？</h3>
            <button onclick="toggleFeedbackPanel()" class="close-feedback">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        
        <div class="feedback-options">
            <button onclick="submitFeedback('correct')" class="feedback-option positive">
                <i data-lucide="thumbs-up" class="w-4 h-4"></i>
                正確
            </button>
            <button onclick="submitFeedback('incorrect')" class="feedback-option negative">
                <i data-lucide="thumbs-down" class="w-4 h-4"></i>
                修正が必要
            </button>
        </div>
        
        <div class="feedback-detail">
            <textarea placeholder="詳細なフィードバックがあればご記入ください..." rows="3"></textarea>
            <button onclick="submitDetailedFeedback()" class="submit-feedback">送信</button>
        </div>
    </div>
</div>
</div>

<script>
    let summaryLoaded = false;
    let fullContentVisible = false;
    let showingDetailedSummary = false;
    let currentTab = 'summary';
    
    // Tab switching functionality
    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        currentTab = tabName;
        
        // Load content if needed
        if (tabName === 'summary' && !summaryLoaded) {
            loadSummary();
        }
    }
    
    // Tab button event listeners
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switchTab(this.dataset.tab);
        });
    });
    
    function loadSummary() {
        const content = document.getElementById('summary-content');
        
        fetch(`/api/documents/{{ document.id }}/summarize`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            const summaryHtml = markdownToHtml(data.short_summary || '要約の生成に失敗しました。');
            content.innerHTML = `
                <div class="summary-box">
                    <div class="summary-text">${summaryHtml}</div>
                </div>
            `;
            
            // Update stats
            const originalLength = {{ document.content_text|length }};
            const summaryLength = data.short_summary ? data.short_summary.length : 0;
            const ratio = originalLength > 0 ? Math.round((summaryLength / originalLength) * 100) : 0;
            
            document.getElementById('summary-ratio').textContent = ratio + '%';
            document.getElementById('keyword-count').textContent = '5個'; // Mock data
            
            summaryLoaded = true;
        })
        .catch(error => {
            content.innerHTML = `
                <div class="error-box">
                    <p>要約の生成中にエラーが発生しました。</p>
                </div>
            `;
        });
    }
    
    function showFullContent() {
        document.getElementById('content-preview').classList.add('hidden');
        document.getElementById('content-full').classList.remove('hidden');
        fullContentVisible = true;
    }
    
    function toggleSummaryLength() {
        const btn = document.getElementById('summary-length-toggle');
        const icon = btn.querySelector('i');
        const text = btn.childNodes[2] || btn;
        
        showingDetailedSummary = !showingDetailedSummary;
        
        if (showingDetailedSummary) {
            text.textContent = ' 短縮版';
            icon.setAttribute('data-lucide', 'minimize-2');
        } else {
            text.textContent = ' 詳細版';
            icon.setAttribute('data-lucide', 'maximize-2');
        }
        
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }
    
    function toggleFeedbackPanel() {
        const panel = document.getElementById('feedback-panel');
        panel.classList.toggle('hidden');
    }
    
    function submitFeedback(label) {
        fetch(`/api/documents/{{ document.id }}/feedback`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ label: label })
        })
        .then(response => response.json())
        .then(data => {
            alert(label === 'correct' ? 'フィードバックありがとうございます！' : '修正のご指摘ありがとうございます。');
            toggleFeedbackPanel();
        })
        .catch(error => {
            alert('フィードバックの送信に失敗しました。');
        });
    }
    
    function submitDetailedFeedback() {
        const textarea = document.querySelector('.feedback-detail textarea');
        const feedback = textarea.value.trim();
        
        if (!feedback) {
            alert('フィードバック内容を入力してください。');
            return;
        }
        
        // Submit detailed feedback
        fetch(`/api/documents/{{ document.id }}/feedback`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                label: 'detailed',
                comment: feedback
            })
        })
        .then(response => response.json())
        .then(data => {
            alert('詳細なフィードバックをありがとうございます！');
            textarea.value = '';
            toggleFeedbackPanel();
        })
        .catch(error => {
            alert('フィードバックの送信に失敗しました。');
        });
    }
    
    // Utility functions
    function regenerateSummary() {
        summaryLoaded = false;
        document.getElementById('summary-content').innerHTML = `
            <div class="summary-loading">
                <div class="loading-spinner"></div>
                <p>要約を再生成中...</p>
            </div>
        `;
        loadSummary();
    }
    
    function toggleReadingMode() {
        document.body.classList.toggle('reading-mode');
    }
    
    function copyContent() {
        const content = document.querySelector('.content-body').innerText;
        navigator.clipboard.writeText(content).then(() => {
            alert('コンテンツをクリップボードにコピーしました。');
        });
    }
    
    function exportDocument() {
        alert('エクスポート機能は近日実装予定です。');
    }
    
    function updateAnalysis() {
        alert('分析を更新しました。');
    }
    
    // Simple Markdown to HTML converter
    function markdownToHtml(text) {
        if (!text) return '';
        
        return text
            .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
            .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>')
            .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-4 mb-2">$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
            .replace(/__(.*?)__/g, '<strong class="font-semibold">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
            .replace(/_(.*?)_/g, '<em class="italic">$1</em>')
            .replace(/```(.*?)```/gs, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">$1</code>')
            .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm font-mono">$1</code>')
            .replace(/^[\-\*] (.*$)/gim, '<li class="ml-4">• $1</li>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        loadSummary(); // Auto-load summary
    });
</script>
{% endblock %}