{% extends "base.html" %}

{% block title %}{{ document.title }} - Scrap-Board{% endblock %}

{% block content %}
<div class="document-container">
    <div class="max-w-4xl mx-auto px-6 py-8">
        <!-- Clean Back Button -->
        <a href="/documents" class="dify-back-btn">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            <span>ドキュメント一覧に戻る</span>
        </a>
        
        <!-- Document Header Card -->
        <div class="dify-header-card">
            {% include 'partials/_document_meta.html' %}
            
            <!-- Categories and Tags -->
            {% if document.classifications %}
            <div class="tag-list flex flex-wrap items-center mb-6">
                <span class="dify-tag-primary">
                    <i data-lucide="tag" class="w-4 h-4"></i>
                    {{ document.classifications[0].primary_category }}
                </span>
                
                {% if document.classifications[0].tags %}
                {% for tag in document.classifications[0].tags %}
                <span class="dify-tag-secondary">
                    {{ tag }}
                </span>
                {% endfor %}
                {% endif %}
                
                <span class="dify-confidence-badge">
                    <i data-lucide="trending-up" class="w-3 h-3"></i>
                    信頼度: {{ "%.0f" | format(document.classifications[0].confidence * 100) }}%
                </span>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="dify-actions">
                <a href="/reader/{{ document.id }}" class="dify-btn dify-btn-primary">
                    <i data-lucide="book-open" class="w-4 h-4"></i>
                    <span>Reader Mode で読む</span>
                </a>
                
                {% if document.url %}
                <a href="{{ document.url }}" target="_blank" class="dify-btn dify-btn-secondary">
                    <i data-lucide="external-link" class="w-4 h-4"></i>
                    <span>元記事を開く</span>
                </a>
                {% endif %}
                
                <button 
                    id="content-view-toggle"
                    onclick="toggleContentView()"
                    class="dify-btn dify-btn-outline"
                >
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    <span>全文を表示</span>
                </button>
            </div>
        </div>
                <span>元記事を開く</span>
            </a>
            {% endif %}
            
            <button 
                id="content-view-toggle"
                onclick="toggleContentView()"
                class="dify-btn dify-btn-outline"
            >
                <i data-lucide="file-text" class="w-4 h-4"></i>
                <span>全文を表示</span>
            </button>
        </div>
    </div>
    
    <!-- Summary Section -->
    <div id="summary-section" class="dify-content-card">
        <h2 class="dify-section-title">
            <i data-lucide="sparkles" class="w-5 h-5"></i>
            AI要約
        </h2>
        
        <div id="summary-content" class="space-y-4">
            <div class="animate-pulse space-y-3">
                <div class="dify-loading-line w-3/4"></div>
                <div class="dify-loading-line w-1/2"></div>
                <div class="dify-loading-line w-2/3"></div>
            </div>
        </div>
    </div>
    
    <!-- Content Preview Section -->
    <div id="content-section" class="hidden dify-content-card">
        <div class="dify-content-header">
            <h2 class="dify-section-title">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                コンテンツプレビュー
            </h2>
            <button 
                onclick="toggleFullContent()"
                id="content-toggle"
                class="dify-toggle-btn"
            >
                <span>全文を表示</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
        
        <div id="content-preview" class="prose max-w-none">
            <div class="dify-content-text">
                {{ document.content_md[:500] | markdown | safe }}{% if document.content_md|length > 500 %}<span class="text-gray-400">...</span>{% endif %}
            </div>
        </div>
        
        <div id="content-full" class="hidden prose max-w-none">
            <div class="dify-content-text">
                {{ document.content_md | safe }}
            </div>
        </div>
    </div>
    
    <!-- Similar Documents Section -->
    <div class="dify-content-card">
        <h2 class="dify-section-title">
            <i data-lucide="link" class="w-5 h-5"></i>
            関連ドキュメント
        </h2>
        
        <div 
            hx-get="/api/documents/{{ document.id }}/similar"
            hx-trigger="load"
            hx-target="#similar-documents"
            class="mt-6"
        >
            <div id="similar-documents" class="grid md:grid-cols-2 gap-4">
                <!-- Loading State -->
                <div class="space-y-4">
                    <div class="dify-similar-card animate-pulse">
                        <div class="dify-loading-line w-3/4 mb-3"></div>
                        <div class="dify-loading-line w-1/2"></div>
                    </div>
                    <div class="dify-similar-card animate-pulse">
                        <div class="dify-loading-line w-2/3 mb-3"></div>
                        <div class="dify-loading-line w-1/3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Feedback Section -->
    <div class="dify-feedback-card">
        <div class="dify-feedback-grid">
            <div class="dify-feedback-icon">
                <i data-lucide="thumbs-up" class="w-6 h-6"></i>
            </div>
            
            <div class="dify-feedback-content">
                <h3>この分類は正確ですか？</h3>
                <p>あなたのフィードバックは分類精度の向上に活用されます。</p>
                <div class="dify-feedback-actions">
                    <button onclick="submitFeedback('correct', this)" class="dify-feedback-btn dify-feedback-primary" aria-pressed="false">
                        <i data-lucide="check" class="w-4 h-4"></i>
                        <span>正確</span>
                    </button>
                    <button onclick="submitFeedback('incorrect', this)" class="dify-feedback-btn dify-feedback-secondary" aria-pressed="false">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        <span>修正が必要</span>
                    </button>
                </div>
            </div>
            
            <div class="dify-feedback-status">
                <div class="dify-feedback-message" aria-live="polite" role="status" hidden></div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
    let summaryLoaded = false;
    let fullContentVisible = false;
    let showingSummary = true; // Track current view state - start with summary view
    
    // Simple Markdown to HTML converter for AI summaries
    function markdownToHtml(text) {
        if (!text) return '';
        
        return text
            // Headers (支持# ## ###)
            .replace(/^### (.*$)/gim, '<h3 class="text-lg font-semibold mt-4 mb-2">$1</h3>')
            .replace(/^## (.*$)/gim, '<h2 class="text-xl font-semibold mt-4 mb-2">$1</h2>')
            .replace(/^# (.*$)/gim, '<h1 class="text-2xl font-bold mt-4 mb-2">$1</h1>')
            
            // Bold text (**bold** や __bold__)
            .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>')
            .replace(/__(.*?)__/g, '<strong class="font-semibold">$1</strong>')
            
            // Italic text (*italic* や _italic_)
            .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
            .replace(/_(.*?)_/g, '<em class="italic">$1</em>')
            
            // Code blocks (```code```)
            .replace(/```(.*?)```/gs, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">$1</code>')
            
            // Inline code (`code`)
            .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm font-mono">$1</code>')
            
            // Lists (- item や * item)
            .replace(/^[\-\*] (.*$)/gim, '<li class="ml-4">• $1</li>')
            
            // Line breaks (double newlines become <br>)
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
    }
    
    // Auto-load summary on page load
    function autoLoadSummary() {
        const content = document.getElementById('summary-content');
        
        if (!summaryLoaded) {
            // Load summary via AI
            fetch(`/api/documents/{{ document.id }}/summarize`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                const summaryHtml = markdownToHtml(data.short_summary || '要約の生成に失敗しました。');
                content.innerHTML = `
                    <div class="dify-summary-container">
                        <div class="dify-summary-badge">
                            <i data-lucide="sparkles" class="w-3 h-3"></i>
                            <span>AI生成要約</span>
                        </div>
                        <div class="dify-summary-content">${summaryHtml}</div>
                    </div>
                `;
                summaryLoaded = true;
            })
            .catch(error => {
                content.innerHTML = `
                    <div class="dify-error-container">
                        <div class="dify-error-icon">
                            <i data-lucide="alert-circle" class="w-5 h-5"></i>
                        </div>
                        <p class="dify-error-text">要約の生成中にエラーが発生しました。</p>
                    </div>
                `;
            });
        }
    }
    
    // Toggle between summary view and full content view
    function toggleContentView() {
        const summarySection = document.getElementById('summary-section');
        const contentSection = document.getElementById('content-section');
        const toggleButton = document.getElementById('content-view-toggle');
        const toggleIcon = toggleButton.querySelector('i');
        const toggleText = toggleButton.querySelector('span');
        
        if (showingSummary) {
            // Switch to full content view
            summarySection.classList.add('hidden');
            contentSection.classList.remove('hidden');
            toggleText.textContent = '要約に戻る';
            toggleIcon.setAttribute('data-lucide', 'arrow-left');
            showingSummary = false;
        } else {
            // Switch to summary view
            summarySection.classList.remove('hidden');
            contentSection.classList.add('hidden');
            toggleText.textContent = '全文を表示';
            toggleIcon.setAttribute('data-lucide', 'file-text');
            showingSummary = true;
        }
        
        // Re-initialize lucide icons after changing them
        if (window.lucide) {
            window.lucide.createIcons();
        }
    }
    
    function toggleFullContent() {
        const preview = document.getElementById('content-preview');
        const full = document.getElementById('content-full');
        const toggle = document.getElementById('content-toggle');
        
        if (fullContentVisible) {
            preview.classList.remove('hidden');
            full.classList.add('hidden');
            toggle.textContent = '全文を表示';
            fullContentVisible = false;
        } else {
            preview.classList.add('hidden');
            full.classList.remove('hidden');
            toggle.textContent = '概要に戻る';
            fullContentVisible = true;
        }
    }
    
    function submitFeedback(label, buttonEl) {
        const messageEl = document.querySelector('.feedback-message');
        const btn = buttonEl || null;
        if (btn) {
            btn.setAttribute('aria-pressed', 'true');
            btn.disabled = true;
        }

        fetch(`/api/documents/{{ document.id }}/feedback`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ label: label })
        })
        .then(response => response.json())
        .then(data => {
            if (messageEl) {
                messageEl.hidden = false;
                messageEl.className = 'dify-feedback-message success';
                messageEl.innerHTML = `
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span>${label === 'correct' ? 'フィードバックありがとうございます！' : '修正のご指摘を受け取りました。ありがとうございます。'}</span>
                `;
            } else {
                alert(label === 'correct' ? 'フィードバックありがとうございます！' : '修正のご指摘ありがとうございます。');
            }
        })
        .catch(error => {
            if (messageEl) {
                messageEl.hidden = false;
                messageEl.className = 'dify-feedback-message error';
                messageEl.innerHTML = `
                    <i data-lucide="x-circle" class="w-4 h-4"></i>
                    <span>フィードバックの送信に失敗しました。後でもう一度お試しください。</span>
                `;
            } else {
                alert('フィードバックの送信に失敗しました。');
            }
        })
        .finally(() => {
            if (btn) {
                setTimeout(() => { btn.disabled = false; btn.setAttribute('aria-pressed', 'false'); }, 1200);
            }
        });
    }
    
    // Initialize icons and auto-load summary
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
        autoLoadSummary(); // Auto-load summary on page load
    });
</script>
{% endblock %}